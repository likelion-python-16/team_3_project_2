# Team3 Cafe Analysis 운영 가이드

## 목차
1. [실행](#실행)
2. [배포](#배포)
3. [헬스체크](#헬스체크)
4. [모니터링](#모니터링)

---

## 실행

### 로컬 개발 환경 실행

#### 1. 사전 요구사항
```bash
# Python 3.11 이상 필요
python --version

# 가상환경 생성 및 활성화
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 또는
venv\Scripts\activate     # Windows
```

#### 2. 의존성 설치
```bash
# 프로젝트 루트 디렉토리에서
pip install -r requirements.txt
```

#### 3. 환경 변수 설정
```bash
# .env 파일 생성 (선택사항)
cp .env.example .env

# 필수 환경 변수
export SECRET_KEY="your-secret-key"
export DEBUG=True
export TOSS_SECRET_KEY="test_sk_6BYq7GWPVvxKzQ7Dq0qm8NE5vbo1"
```

#### 4. 데이터베이스 설정
```bash
# 마이그레이션 실행
python manage.py migrate

# 정적 파일 수집
python manage.py collectstatic --noinput

# 슈퍼유저 생성 (선택사항)
python manage.py createsuperuser
```

#### 5. 서버 실행
```bash
# 개발 서버 실행
python manage.py runserver

# 특정 포트로 실행
python manage.py runserver 8080

# 모든 인터페이스에서 접근 허용
python manage.py runserver 0.0.0.0:8000
```

#### 6. 접속 확인
- **메인 페이지**: http://localhost:8000/
- **관리자 페이지**: http://localhost:8000/admin/
- **API 문서**: http://localhost:8000/docs/
- **헬스체크**: http://localhost:8000/health/

### 프로덕션 환경 실행

#### Gunicorn을 사용한 실행
```bash
# Gunicorn 실행
gunicorn team3.wsgi:application --bind 0.0.0.0:8000 --workers 2

# 로그 출력과 함께 실행
gunicorn team3.wsgi:application \
    --bind 0.0.0.0:8000 \
    --workers 2 \
    --access-logfile - \
    --error-logfile - \
    --log-level info
```

#### Docker를 사용한 실행
```bash
# Docker 이미지 빌드
docker build -t team3-cafe-analysis .

# Docker 컨테이너 실행
docker run -d \
    --name team3-app \
    -p 8000:8000 \
    -e SECRET_KEY="your-secret-key" \
    team3-cafe-analysis
```

---

## 배포

### Fly.io 배포

#### 1. 사전 준비

##### flyctl CLI 설치
```bash
# macOS
brew install flyctl

# Linux
curl -L https://fly.io/install.sh | sh

# Windows (PowerShell)
powershell -Command "iwr https://fly.io/install.ps1 -useb | iex"
```

##### 인증
```bash
# Fly.io 로그인
flyctl auth login

# 현재 인증 상태 확인
flyctl auth whoami
```

#### 2. 배포 설정 확인

##### fly.toml 파일 검증
```bash
# 설정 파일 유효성 검사
flyctl config validate
```

##### 현재 설정 확인
```toml
# fly.toml 주요 설정
app = 'team3-project-2-app'
primary_region = 'sjc'

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = 'off'
  auto_start_machines = true
  min_machines_running = 1

[[http_service.checks]]
  interval = "15s"
  timeout = "10s"
  method = "GET"
  path = "/health/"
  grace_period = "30s"
```

#### 3. 환경 변수 설정
```bash
# 비밀 정보 설정
flyctl secrets set SECRET_KEY="your-production-secret-key" -a team3-project-2-app
flyctl secrets set TOSS_SECRET_KEY="your-toss-secret-key" -a team3-project-2-app

# 환경 변수 목록 확인
flyctl secrets list -a team3-project-2-app
```

#### 4. 배포 실행
```bash
# 기본 배포
flyctl deploy -a team3-project-2-app

# 즉시 배포 (롤링 업데이트 없이)
flyctl deploy -a team3-project-2-app --strategy immediate

# 특정 이미지로 배포
flyctl deploy -a team3-project-2-app --image your-custom-image
```

#### 5. 배포 상태 확인
```bash
# 앱 상태 확인
flyctl status -a team3-project-2-app

# 머신 목록 확인
flyctl machines list -a team3-project-2-app

# 로그 확인
flyctl logs -a team3-project-2-app

# 실시간 로그 스트리밍
flyctl logs -a team3-project-2-app -f
```

### GitHub Actions를 통한 자동 배포

#### 워크플로우 파일 (`.github/workflows/fly-deploy.yml`)
```yaml
name: Deploy to Fly.io

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - uses: superfly/flyctl-actions/setup-flyctl@master
      
      - run: flyctl deploy --remote-only -a team3-project-2-app
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
```

#### 배포 트리거
- **자동 배포**: `main` 브랜치에 푸시 시
- **수동 배포**: GitHub Actions에서 수동 실행

---

## 헬스체크

### 헬스체크 엔드포인트

#### 기본 헬스체크
```bash
# 기본 상태 확인
curl -I https://team3-project-2-app.fly.dev/health/

# 응답 예시
HTTP/2 200 
content-type: text/html; charset=utf-8
content-length: 2
```

#### 상세 헬스체크
```bash
# JSON 형태로 상세 정보 확인
curl https://team3-project-2-app.fly.dev/health/

# 응답 예시
OK
```

### 자동 헬스체크 설정

#### Fly.io 헬스체크 설정
```toml
# fly.toml
[[http_service.checks]]
  interval = "15s"         # 체크 간격
  timeout = "10s"          # 타임아웃
  method = "GET"           # HTTP 메서드
  path = "/health/"        # 체크 경로
  grace_period = "30s"     # 유예 시간
```

#### 헬스체크 상태 모니터링
```bash
# 현재 헬스체크 상태 확인
flyctl status -a team3-project-2-app

# 특정 머신의 헬스체크 상태
flyctl machine status MACHINE_ID -a team3-project-2-app
```

### 헬스체크 문제 해결

#### 일반적인 문제들
1. **503 Service Unavailable**
   ```bash
   # 로그 확인
   flyctl logs -a team3-project-2-app
   
   # 머신 재시작
   flyctl machine restart MACHINE_ID -a team3-project-2-app
   ```

2. **헬스체크 실패**
   ```bash
   # 헬스체크 상세 로그 확인
   flyctl logs -a team3-project-2-app --grep "health"
   
   # 수동으로 헬스체크 엔드포인트 테스트
   curl -v https://team3-project-2-app.fly.dev/health/
   ```

3. **타임아웃 문제**
   ```bash
   # 더 긴 타임아웃으로 설정
   # fly.toml에서 timeout 값 증가
   timeout = "20s"
   ```

---

## 모니터링

### Prometheus 메트릭

#### 메트릭 엔드포인트
```bash
# Prometheus 메트릭 확인
curl https://team3-project-2-app.fly.dev/metrics/

# 메트릭 예시
# HELP django_http_requests_total Total HTTP requests
# TYPE django_http_requests_total counter
django_http_requests_total{method="GET",status="200"} 1234
```

#### 주요 모니터링 메트릭
- **HTTP 요청 수**: `django_http_requests_total`
- **응답 시간**: `django_http_request_duration_seconds`
- **에러율**: `django_http_responses_total{status="5xx"}`
- **데이터베이스 연결**: `django_db_connections_total`

### 로그 모니터링

#### 실시간 로그 스트리밍
```bash
# 모든 로그 스트리밍
flyctl logs -a team3-project-2-app -f

# 에러 로그만 필터링
flyctl logs -a team3-project-2-app -f --grep "ERROR"

# 특정 머신의 로그
flyctl logs -a team3-project-2-app -f -i MACHINE_ID
```

#### 로그 레벨별 모니터링
```bash
# INFO 레벨 로그
flyctl logs -a team3-project-2-app --grep "INFO"

# WARNING 레벨 로그
flyctl logs -a team3-project-2-app --grep "WARNING"

# ERROR 레벨 로그
flyctl logs -a team3-project-2-app --grep "ERROR"
```

### 성능 모니터링

#### 애플리케이션 성능 지표
```bash
# 응답 시간 모니터링
curl -w "@curl-format.txt" -o /dev/null -s https://team3-project-2-app.fly.dev/

# curl-format.txt 파일 내용:
#      time_namelookup:  %{time_namelookup}\n
#         time_connect:  %{time_connect}\n
#      time_appconnect:  %{time_appconnect}\n
#     time_pretransfer:  %{time_pretransfer}\n
#        time_redirect:  %{time_redirect}\n
#   time_starttransfer:  %{time_starttransfer}\n
#                      ----------\n
#           time_total:  %{time_total}\n
```

#### 머신 리소스 모니터링
```bash
# 머신 상태 및 리소스 사용량
flyctl machine status MACHINE_ID -a team3-project-2-app

# 머신 목록과 상태
flyctl machines list -a team3-project-2-app
```

### 알림 설정

#### 기본 모니터링 체크리스트
- [ ] **헬스체크 상태**: 15초마다 자동 체크
- [ ] **응답 시간**: 2초 이내 유지
- [ ] **에러율**: 5% 이하 유지
- [ ] **가용성**: 99% 이상 유지

#### 모니터링 명령어 스크립트
```bash
#!/bin/bash
# monitoring-check.sh

echo "=== 앱 상태 확인 ==="
flyctl status -a team3-project-2-app

echo "=== 헬스체크 확인 ==="
curl -I https://team3-project-2-app.fly.dev/health/

echo "=== 최근 에러 로그 확인 ==="
flyctl logs -a team3-project-2-app --grep "ERROR" -n 10

echo "=== 머신 상태 확인 ==="
flyctl machines list -a team3-project-2-app
```

### 장애 대응

#### 긴급 대응 절차
1. **서비스 다운 시**
   ```bash
   # 즉시 상태 확인
   flyctl status -a team3-project-2-app
   
   # 로그 확인
   flyctl logs -a team3-project-2-app -n 50
   
   # 머신 재시작
   flyctl machine restart MACHINE_ID -a team3-project-2-app
   ```

2. **성능 저하 시**
   ```bash
   # 스케일링
   flyctl scale count 3 -a team3-project-2-app
   
   # 메모리 확장
   flyctl scale memory 2gb -a team3-project-2-app
   ```

3. **데이터베이스 문제 시**
   ```bash
   # 데이터베이스 연결 확인
   flyctl ssh console -a team3-project-2-app -C "python manage.py dbshell"
   
   # 마이그레이션 재실행
   flyctl ssh console -a team3-project-2-app -C "python manage.py migrate"
   ```

#### 롤백 절차
```bash
# 이전 릴리스로 롤백
flyctl releases -a team3-project-2-app
flyctl rollback -a team3-project-2-app -r VERSION_NUMBER

# 특정 이미지로 롤백
flyctl deploy -a team3-project-2-app --image previous-image-tag
```

### 정기 점검 체크리스트

#### 일일 점검
- [ ] 헬스체크 상태 확인
- [ ] 에러 로그 검토
- [ ] 응답 시간 확인
- [ ] 디스크 사용량 확인

#### 주간 점검
- [ ] 성능 메트릭 리뷰
- [ ] 보안 로그 검토
- [ ] 백업 상태 확인
- [ ] 의존성 업데이트 검토

#### 월간 점검
- [ ] 전체 시스템 성능 분석
- [ ] 사용자 사용 패턴 분석
- [ ] 리소스 사용량 최적화
- [ ] 보안 패치 적용

---

## 문제 해결 가이드

### 자주 발생하는 문제들

#### 1. 배포 실패
```bash
# 문제 진단
flyctl logs -a team3-project-2-app

# 해결 방법
- Docker 이미지 빌드 확인
- 환경 변수 설정 확인
- fly.toml 설정 검증
```

#### 2. 성능 저하
```bash
# 문제 진단
flyctl metrics -a team3-project-2-app

# 해결 방법
- 머신 스케일링
- 메모리 증설
- 캐시 최적화
```

#### 3. 데이터베이스 오류
```bash
# 문제 진단
flyctl ssh console -a team3-project-2-app -C "python manage.py check --database default"

# 해결 방법
- 마이그레이션 재실행
- 데이터베이스 연결 설정 확인
- 백업에서 복구
```

---

**문서 버전**: 1.0  
**최종 수정일**: 2025년 9월 10일  
**담당자**: Team3 운영팀