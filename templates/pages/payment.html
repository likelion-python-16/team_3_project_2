{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>결제 - 골목상권 빅데이터 분석</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <script src="https://js.tosspayments.com/v2/standard"></script>
  
  <style>
    .payment-hero {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      color: white;
      padding: 60px 0;
      text-align: center;
    }
    
    .payment-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    .payment-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 40px;
    }
    
    .order-summary {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      height: fit-content;
    }
    
    .payment-form {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
    
    .plan-card {
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }
    
    .plan-title {
      font-size: 24px;
      font-weight: bold;
      margin: 0 0 8px 0;
      color: #059669;
    }
    
    .plan-price {
      font-size: 32px;
      font-weight: bold;
      color: #047857;
      margin: 16px 0;
    }
    
    .plan-features {
      list-style: none;
      padding: 0;
      margin: 16px 0 0 0;
    }
    
    .plan-features li {
      padding: 8px 0;
      color: #374151;
      display: flex;
      align-items: center;
    }
    
    .plan-features li::before {
      content: "✓";
      color: #10b981;
      font-weight: bold;
      margin-right: 8px;
    }
    
    .price-breakdown {
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
      margin-top: 20px;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      color: #6b7280;
    }
    
    .price-row.total {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
      margin-top: 12px;
      font-weight: bold;
      font-size: 18px;
      color: #111827;
    }
    
    .payment-widget {
      margin: 24px 0;
      min-height: 300px;
    }
    
    .btn-payment {
      width: 100%;
      background: #059669;
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .btn-payment:hover {
      background: #047857;
    }
    
    .btn-payment:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .security-info {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
      font-size: 14px;
      color: #6b7280;
      text-align: center;
    }
    
    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px 0;
      color: #6b7280;
    }
    
    @media (max-width: 768px) {
      .payment-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }
    }
    
    /* 토스 페이먼츠 위젯 CSS 오버라이드 */
    #payment-method button,
    #payment-method [role="button"] {
      min-height: 56px !important;
      height: auto !important;
      padding: 12px 16px !important;
      white-space: nowrap !important;
      overflow: visible !important;
      text-overflow: clip !important;
    }
    
    /* 토스 페이먼츠 위젯 내부 요소 스타일 조정 */
    #payment-method .tosspayments-widget,
    #payment-method iframe {
      min-height: 300px !important;
    }
    
    /* 결제 수단 버튼 텍스트 스타일 */
    #payment-method button span,
    #payment-method [role="button"] span {
      font-size: 14px !important;
      line-height: 1.4 !important;
      word-break: keep-all !important;
    }
    
    /* 결제 방법 선택 영역 전체 스타일 */
    #payment-method {
      min-height: 300px;
      overflow: visible;
    }
    
    /* 약관 동의 영역 스타일 */
    #agreement {
      margin-top: 20px;
      min-height: 100px;
    }
    
    /* 토스 페이먼츠 그리드 컬럼 크기 조정 */
    .p-grid-col.p-grid-col3,
    #payment-method .p-grid-col.p-grid-col3 {
      width: 100% !important;
      flex: 1 1 100% !important;
      max-width: 100% !important;
      min-width: 200px !important;
    }
    
    /* 그리드 컨테이너 조정 */
    .p-grid,
    #payment-method .p-grid {
      width: 100% !important;
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 8px !important;
    }
    
    /* 구독 옵션 스타일 */
    .subscription-options {
      margin-bottom: 24px;
    }
    
    .option-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .option-card:hover {
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
    }
    
    .option-card input[type="radio"] {
      display: none;
    }
    
    .option-card input[type="radio"]:checked + label {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      border-color: #10b981;
    }
    
    .option-card input[type="radio"]:checked + label::before {
      content: '✓';
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      background: #10b981;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    
    .option-card label {
      display: block;
      padding: 20px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 10px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .option-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .option-title {
      font-size: 18px;
      font-weight: bold;
      color: #374151;
    }
    
    .option-price {
      font-size: 20px;
      font-weight: bold;
      color: #059669;
    }
    
    .option-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .monthly-price {
      font-size: 14px;
      color: #6b7280;
    }
    
    .discount-badge {
      background: #fbbf24;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .discount-badge.popular {
      background: #ef4444;
      position: relative;
    }
    
    .discount-badge.popular::after {
      content: '인기';
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc2626;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      white-space: nowrap;
    }
    
    .savings {
      font-size: 12px;
      color: #059669;
      font-weight: bold;
      text-align: right;
    }
    
    .plan-features-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="topbar">
    <div class="container topbar__row">
      <div class="logo">
        <a href="/" style="text-decoration: none; color: inherit;">
          <span>🧭</span>
          <span class="logo__title">골목상권 빅데이터 분석</span>
        </a>
      </div>
      <nav class="top-actions">
        <a href="/account" class="btn btn--ghost">내 계정</a>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="payment-hero">
    <div class="container">
      <h1>🎯 프리미엄 구독 결제</h1>
      <p>무제한 상권 분석으로 성공적인 투자를 시작하세요</p>
    </div>
  </section>

  <!-- Main Content -->
  <div class="payment-container">
    <div class="payment-grid">
      
      <!-- Order Summary -->
      <div class="order-summary">
        <h2>주문 요약</h2>
        
        <div class="subscription-options">
          <h3 style="margin-bottom: 24px; color: #374151;">구독 기간 선택</h3>
          
          <div class="option-card" data-duration="1" data-price="9500">
            <input type="radio" id="plan-1month" name="subscription-plan" value="1" checked>
            <label for="plan-1month">
              <div class="option-header">
                <span class="option-title">1개월</span>
                <span class="option-price">₩9,500</span>
              </div>
              <div class="option-details">
                <span class="monthly-price">월 ₩9,500</span>
              </div>
            </label>
          </div>
          
          <div class="option-card" data-duration="6" data-price="45600">
            <input type="radio" id="plan-6month" name="subscription-plan" value="6">
            <label for="plan-6month">
              <div class="option-header">
                <span class="option-title">6개월</span>
                <span class="option-price">₩45,600</span>
              </div>
              <div class="option-details">
                <span class="monthly-price">월 ₩7,600</span>
                <span class="discount-badge">20% 할인</span>
              </div>
              <div class="savings">₩11,400 절약</div>
            </label>
          </div>
          
          <div class="option-card" data-duration="12" data-price="57000">
            <input type="radio" id="plan-12month" name="subscription-plan" value="12">
            <label for="plan-12month">
              <div class="option-header">
                <span class="option-title">12개월</span>
                <span class="option-price">₩57,000</span>
              </div>
              <div class="option-details">
                <span class="monthly-price">월 ₩4,750</span>
                <span class="discount-badge popular">50% 할인</span>
              </div>
              <div class="savings">₩57,000 절약</div>
            </label>
          </div>
        </div>
        
        <div class="plan-features-section">
          <h4 style="margin: 20px 0 16px 0; color: #374151;">포함된 기능</h4>
          <ul class="plan-features">
            <li>무제한 분석 조회</li>
            <li>상세 지역별 분석</li>
            <li>AI 투자 추천</li>
            <li>위험도 분석</li>
            <li>데이터 내보내기</li>
            <li>우선 고객 지원</li>
          </ul>
        </div>
        
        <div class="price-breakdown">
          <div class="price-row">
            <span id="plan-description">프리미엄 플랜 (1개월)</span>
            <span id="plan-price-display">₩9,500</span>
          </div>
          <div class="price-row" id="discount-row" style="display: none;">
            <span>할인</span>
            <span id="discount-amount">-₩0</span>
          </div>
          <div class="price-row">
            <span>구독 기간</span>
            <span id="subscription-period">오늘부터 1개월</span>
          </div>
          <div class="price-row">
            <span>구독 만료일</span>
            <span id="expiry-date">계산 중...</span>
          </div>
          <div class="price-row">
            <span>부가세</span>
            <span>₩0</span>
          </div>
          <div class="price-row total">
            <span>총 결제 금액</span>
            <span id="total-amount">₩9,500</span>
          </div>
        </div>
        
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
          <h4 style="margin: 0 0 12px 0; color: #374151;">구독 혜택</h4>
          <p style="color: #6b7280; font-size: 14px; margin: 0;">
            • 언제든지 구독을 취소할 수 있습니다<br>
            • 첫 7일간 무료 체험 (신규 고객)<br>
            • 월 중 해지 시 일할 계산 환불
          </p>
        </div>
      </div>

      <!-- Payment Form -->
      <div class="payment-form">
        <h2>결제 정보</h2>

        <!-- 토스 페이먼츠 위젯 -->
        <div id="payment-widget" class="payment-widget">
          <div class="loading">
            결제 모듈을 불러오는 중...<br>
            <small id="loading-status" style="color: #6b7280; font-size: 12px;">SDK 로드 확인 중</small>
          </div>
        </div>
        
        <!-- 결제 UI -->
        <div id="payment-method"></div>
        <!-- 이용약관 UI -->
        <div id="agreement"></div>
        
        <button id="payment-button" class="btn-payment" disabled>
          결제하기 (<span id="payment-button-amount">₩9,500</span>)
        </button> 
        
        <div class="security-info">
          🔒 SSL 암호화로 안전하게 보호됩니다<br>
          토스페이먼츠의 안전한 결제 시스템을 사용합니다
        </div>
      </div>
    </div>
  </div>

  <script>
    // 디버깅 로그 함수
    function debugLog(step, data) {
      console.log(`[토스페이먼츠] ${step}:`, data);
    }
    
    // 구독 옵션 데이터
    const subscriptionPlans = {
      1: { duration: 1, price: 9500, originalPrice: 9500, discount: 0, name: "1개월" },
      6: { duration: 6, price: 45600, originalPrice: 57000, discount: 20, name: "6개월" },
      12: { duration: 12, price: 57000, originalPrice: 114000, discount: 50, name: "12개월" }
    };
    
    // 현재 선택된 플랜 (기본값: 1개월)
    let currentPlan = subscriptionPlans[1];
    
    // 가격 포맷 함수
    function formatPrice(price) {
      return '₩' + price.toLocaleString();
    }
    
    // 날짜 포맷 함수 (YYYY년 MM월 DD일 형식)
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}년 ${month}월 ${day}일`;
    }
    
    // 구독 만료일 계산 함수
    function calculateExpiryDate(months) {
      const today = new Date();
      const expiryDate = new Date(today);
      expiryDate.setMonth(today.getMonth() + months);
      return expiryDate;
    }
    
    // 구독 기간 텍스트 생성 함수
    function getSubscriptionPeriodText(months) {
      if (months === 1) {
        return '오늘부터 1개월';
      } else {
        return `오늘부터 ${months}개월`;
      }
    }
    
    // UI 업데이트 함수
    async function updatePriceDisplay(planData) {
      // 플랜 설명 업데이트
      const planDescription = document.getElementById('plan-description');
      if (planDescription) {
        planDescription.textContent = `프리미엄 플랜 (${planData.name})`;
      }
      
      // 플랜 가격 업데이트
      const planPriceDisplay = document.getElementById('plan-price-display');
      if (planPriceDisplay) {
        planPriceDisplay.textContent = formatPrice(planData.price);
      }
      
      // 할인 행 표시/숨김
      const discountRow = document.getElementById('discount-row');
      const discountAmount = document.getElementById('discount-amount');
      if (planData.discount > 0) {
        if (discountRow) discountRow.style.display = 'flex';
        if (discountAmount) {
          const discountValue = planData.originalPrice - planData.price;
          discountAmount.textContent = '-' + formatPrice(discountValue);
        }
      } else {
        if (discountRow) discountRow.style.display = 'none';
      }
      
      // 총 결제 금액 업데이트
      const totalAmount = document.getElementById('total-amount');
      if (totalAmount) {
        totalAmount.textContent = formatPrice(planData.price);
      }
      
      // 결제 버튼 금액 업데이트
      const paymentButtonAmount = document.getElementById('payment-button-amount');
      if (paymentButtonAmount) {
        paymentButtonAmount.textContent = formatPrice(planData.price);
      }
      
      // 구독 기간 업데이트
      const subscriptionPeriod = document.getElementById('subscription-period');
      if (subscriptionPeriod) {
        subscriptionPeriod.textContent = getSubscriptionPeriodText(planData.duration);
      }
      
      // 구독 만료일 업데이트
      const expiryDate = document.getElementById('expiry-date');
      if (expiryDate) {
        const expiryDateValue = calculateExpiryDate(planData.duration);
        expiryDate.textContent = formatDate(expiryDateValue);
      }
      
      // 토스 위젯 금액 업데이트
      await updateWidgetAmount(planData.price);
      
      debugLog('가격 업데이트', {
        plan: planData.name,
        price: planData.price,
        discount: planData.discount,
        duration: planData.duration
      });
    }
    
    // 구독 옵션 선택 이벤트 처리
    function initSubscriptionOptions() {
      const radioButtons = document.querySelectorAll('input[name="subscription-plan"]');
      
      radioButtons.forEach(radio => {
        radio.addEventListener('change', async function() {
          if (this.checked) {
            const duration = parseInt(this.value);
            currentPlan = subscriptionPlans[duration];
            await updatePriceDisplay(currentPlan);
            debugLog('구독 플랜 변경', currentPlan);
          }
        });
      });
      
      debugLog('구독 옵션 초기화', '완료');
    }
    
    // customerKey 생성 함수
    function generateCustomerKey() {
      const key = 'customer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      debugLog('customerKey 생성', key);
      return key;
    }
    
    // orderId 생성 함수
    function generateOrderId() {
      // Django 템플릿에서 user_id 추출
      const userId = '{{ user.user_id|default:"" }}';
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 9);
      
      // user_id가 있으면 포함, 없으면 기본 형식
      const orderId = userId ? `order_${userId}_${timestamp}_${random}` : `order_${timestamp}_${random}`;
      
      debugLog('orderId 생성', { orderId, userId, timestamp, random });
      return orderId;
    }
    
    // 에러 메시지 표시 함수
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
      debugLog('오류 표시', message);
    }
    
    // TossPayments SDK 로드 확인 함수
    function checkTossPaymentsSDK() {
      if (typeof TossPayments === 'undefined') {
        throw new Error('TossPayments SDK가 로드되지 않았습니다.');
      }
      debugLog('TossPayments SDK 로드', '성공');
      return true;
    }
    
    // DOM 요소 존재 확인 함수
    function checkRequiredElements() {
      const requiredElements = [
        'payment-method',
        'agreement', 
        'payment-button',
        'loading-status'
      ];
      
      for (const elementId of requiredElements) {
        const element = document.getElementById(elementId);
        if (!element) {
          throw new Error(`필수 DOM 요소를 찾을 수 없습니다: ${elementId}`);
        }
      }
      debugLog('DOM 요소 체크', '모든 요소 존재');
      return true;
    }
    
    // 토스 위젯 스타일 강제 적용 함수
    function applyTossWidgetStyles() {
      debugLog('스타일 적용', '토스 위젯 스타일 강제 적용 시작');
      
      // MutationObserver로 DOM 변화 감지하여 스타일 적용
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes.length > 0) {
            // p-grid-col3 요소들 찾아서 스타일 적용
            const gridCols = document.querySelectorAll('.p-grid-col3, [class*="p-grid-col3"]');
            gridCols.forEach(function(col) {
              col.style.width = '100%';
              col.style.flex = '1 1 100%';
              col.style.maxWidth = '100%';
              col.style.minWidth = '200px';
              debugLog('스타일 적용', `p-grid-col3 요소에 스타일 적용: ${col.className}`);
            });
            
            // 그리드 컨테이너 스타일 적용
            const grids = document.querySelectorAll('.p-grid, [class*="p-grid"]');
            grids.forEach(function(grid) {
              if (!grid.classList.contains('p-grid-col3')) {
                grid.style.width = '100%';
                grid.style.display = 'flex';
                grid.style.flexWrap = 'wrap';
                grid.style.gap = '8px';
                debugLog('스타일 적용', `p-grid 요소에 스타일 적용: ${grid.className}`);
              }
            });
            
            // 버튼 스타일 적용
            const buttons = document.querySelectorAll('#payment-method button, #payment-method [role="button"]');
            buttons.forEach(function(btn) {
              btn.style.minHeight = '56px';
              btn.style.height = 'auto';
              btn.style.padding = '12px 16px';
              btn.style.whiteSpace = 'nowrap';
              btn.style.overflow = 'visible';
              btn.style.textOverflow = 'clip';
              debugLog('스타일 적용', '버튼 스타일 적용');
            });
          }
        });
      });
      
      // payment-method 영역 관찰 시작
      const paymentMethodArea = document.getElementById('payment-method');
      if (paymentMethodArea) {
        observer.observe(paymentMethodArea, {
          childList: true,
          subtree: true
        });
        
        // 즉시 실행도 해보기
        setTimeout(() => {
          const gridCols = paymentMethodArea.querySelectorAll('.p-grid-col3, [class*="p-grid-col3"]');
          gridCols.forEach(function(col) {
            col.style.width = '100%';
            col.style.flex = '1 1 100%';
            col.style.maxWidth = '100%';
            col.style.minWidth = '200px';
            debugLog('스타일 적용', `즉시 적용 - p-grid-col3: ${col.className}`);
          });
        }, 500);
        
        debugLog('스타일 적용', 'MutationObserver 설정 완료');
      }
    }
    
    // 전역 변수로 위젯 저장
    let tossPaymentsWidgets = null;
    
    // 위젯 금액 업데이트 함수
    async function updateWidgetAmount(amount) {
      if (tossPaymentsWidgets) {
        try {
          await tossPaymentsWidgets.setAmount({
            currency: "KRW",
            value: amount,
          });
          debugLog('위젯 금액 업데이트', `${amount}원 설정 성공`);
        } catch (error) {
          debugLog('위젯 금액 업데이트 오류', error);
        }
      }
    }
    
    // DOM이 로드된 후 실행
    document.addEventListener('DOMContentLoaded', async function() {
      debugLog('초기화 시작', 'DOM 로드 완료');
      
      try {
        // 0. 구독 옵션 초기화
        initSubscriptionOptions();
        
        // 0-1. 초기 구독 기간 정보 설정
        await updatePriceDisplay(currentPlan);
        
        // 1. 사전 체크
        checkTossPaymentsSDK();
        checkRequiredElements();
        
        // 2. 결제위젯 초기화
        debugLog('초기화 단계', '결제위젯 초기화 시작');
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        
        let tossPayments;
        try {
          tossPayments = TossPayments(clientKey);
          debugLog('TossPayments 초기화', '성공');
        } catch (initError) {
          debugLog('TossPayments 초기화 오류', initError);
          throw new Error('클라이언트 키가 잘못되었거나 만료되었습니다.');
        }
        
        // 3. 위젯 생성
        const customerKey = generateCustomerKey();
        try {
          tossPaymentsWidgets = tossPayments.widgets({ customerKey });
          debugLog('위젯 생성', '성공');
        } catch (widgetError) {
          debugLog('위젯 생성 오류', widgetError);
          throw new Error('결제 위젯 생성에 실패했습니다.');
        }
        
        // 4. 결제 금액 설정 (초기값: 1개월 가격)
        try {
          await tossPaymentsWidgets.setAmount({
            currency: "KRW",
            value: currentPlan.price,
          });
          debugLog('금액 설정', `${currentPlan.price}원 설정 성공`);
        } catch (amountError) {
          debugLog('금액 설정 오류', amountError);
          throw new Error('결제 금액 설정에 실패했습니다.');
        }
        
        // 5. 로딩 상태 업데이트
        const loadingStatus = document.getElementById('loading-status');
        if (loadingStatus) {
          loadingStatus.textContent = '결제 UI 렌더링 중...';
        }
        
        // 6. UI 렌더링
        try {
          await Promise.all([
            tossPaymentsWidgets.renderPaymentMethods({
              selector: "#payment-method",
              variantKey: "DEFAULT",
            }),
            tossPaymentsWidgets.renderAgreement({ 
              selector: "#agreement", 
              variantKey: "AGREEMENT" 
            }),
          ]);
          debugLog('UI 렌더링', '결제 UI 및 약관 렌더링 성공');
          
          // 렌더링 완료 후 스타일 강제 적용
          setTimeout(() => {
            applyTossWidgetStyles();
          }, 1000);
        } catch (renderError) {
          debugLog('UI 렌더링 오류', renderError);
          throw new Error('결제 UI 렌더링에 실패했습니다.');
        }
        
        // 7. 로딩 UI 숨기기
        const loadingElement = document.querySelector('.loading');
        if (loadingElement) {
          loadingElement.style.display = 'none';
          debugLog('UI 업데이트', '로딩 UI 숨김');
        }
        
        // 8. 결제 버튼 활성화
        const paymentButton = document.getElementById('payment-button');
        if (paymentButton) {
          paymentButton.disabled = false;
          debugLog('UI 업데이트', '결제 버튼 활성화');
          
          // 9. 결제 버튼 이벤트 리스너 등록
          paymentButton.addEventListener('click', async function() {
            debugLog('결제 요청', '결제 버튼 클릭');
            
            try {
              const orderId = generateOrderId();
              const paymentData = {
                orderId: orderId,
                orderName: `프리미엄 플랜 ${currentPlan.name}`,
                successUrl: window.location.protocol + '//' + window.location.host + "/success",
                failUrl: window.location.protocol + '//' + window.location.host + "/fail",
                customerEmail: "test@example.com",
                customerName: "테스트유저",
                customerMobilePhone: "01012345678",
              };
              
              debugLog('결제 데이터', paymentData);
              
              await tossPaymentsWidgets.requestPayment(paymentData);
              debugLog('결제 요청', '결제창 뜨움');
              
            } catch (paymentError) {
              debugLog('결제 요청 오류', {
                message: paymentError.message,
                code: paymentError.code,
                stack: paymentError.stack
              });
              
              let errorMessage = '결제 요청 중 오류가 발생했습니다.';
              
              // 오류 코드에 따른 상세 메시지
              if (paymentError.code) {
                switch (paymentError.code) {
                  case 'UNAUTHORIZED_KEY':
                    errorMessage = '인증되지 않은 클라이언트 키입니다.';
                    break;
                  case 'INVALID_REQUEST':
                    errorMessage = '잘못된 요청입니다. 결제 정보를 확인해주세요.';
                    break;
                  case 'USER_CANCEL':
                    errorMessage = '사용자가 결제를 취소했습니다.';
                    break;
                  default:
                    errorMessage = `결제 오류: ${paymentError.message || '알 수 없는 오류'}`;
                }
              }
              
              showError(errorMessage);
            }
          });
        }
        
        debugLog('초기화 완료', '모든 설정이 완료되었습니다.');
        
      } catch (error) {
        debugLog('초기화 오류', {
          message: error.message,
          stack: error.stack
        });
        
        showError(error.message || '결제 시스템을 불러오는 중 오류가 발생했습니다.');
        
        const loadingElement = document.querySelector('.loading');
        if (loadingElement) {
          loadingElement.innerHTML = '<span style="color: #dc2626;">결제 시스템 로드 실패</span>';
        }
      }
    });
  </script>
</body>
</html>