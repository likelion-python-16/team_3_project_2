{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ê²°ì œ - ê³¨ëª©ìƒê¶Œ ë¹…ë°ì´í„° ë¶„ì„</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <script src="https://js.tosspayments.com/v2/standard"></script>
  
  <style>
    .payment-hero {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      color: white;
      padding: 60px 0;
      text-align: center;
    }
    
    .payment-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    .payment-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 40px;
    }
    
    .order-summary {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      height: fit-content;
    }
    
    .payment-form {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
    
    .plan-card {
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }
    
    .plan-title {
      font-size: 24px;
      font-weight: bold;
      margin: 0 0 8px 0;
      color: #059669;
    }
    
    .plan-price {
      font-size: 32px;
      font-weight: bold;
      color: #047857;
      margin: 16px 0;
    }
    
    .plan-features {
      list-style: none;
      padding: 0;
      margin: 16px 0 0 0;
    }
    
    .plan-features li {
      padding: 8px 0;
      color: #374151;
      display: flex;
      align-items: center;
    }
    
    .plan-features li::before {
      content: "âœ“";
      color: #10b981;
      font-weight: bold;
      margin-right: 8px;
    }
    
    .price-breakdown {
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
      margin-top: 20px;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      color: #6b7280;
    }
    
    .price-row.total {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
      margin-top: 12px;
      font-weight: bold;
      font-size: 18px;
      color: #111827;
    }
    
    .payment-widget {
      margin: 24px 0;
      min-height: 300px;
    }
    
    .btn-payment {
      width: 100%;
      background: #059669;
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .btn-payment:hover {
      background: #047857;
    }
    
    .btn-payment:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .security-info {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
      font-size: 14px;
      color: #6b7280;
      text-align: center;
    }
    
    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px 0;
      color: #6b7280;
    }
    
    @media (max-width: 768px) {
      .payment-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }
    }
    
    /* í† ìŠ¤ í˜ì´ë¨¼ì¸  ìœ„ì ¯ CSS ì˜¤ë²„ë¼ì´ë“œ */
    #payment-method button,
    #payment-method [role="button"] {
      min-height: 56px !important;
      height: auto !important;
      padding: 12px 16px !important;
      white-space: nowrap !important;
      overflow: visible !important;
      text-overflow: clip !important;
    }
    
    /* í† ìŠ¤ í˜ì´ë¨¼ì¸  ìœ„ì ¯ ë‚´ë¶€ ìš”ì†Œ ìŠ¤íƒ€ì¼ ì¡°ì • */
    #payment-method .tosspayments-widget,
    #payment-method iframe {
      min-height: 300px !important;
    }
    
    /* ê²°ì œ ìˆ˜ë‹¨ ë²„íŠ¼ í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
    #payment-method button span,
    #payment-method [role="button"] span {
      font-size: 14px !important;
      line-height: 1.4 !important;
      word-break: keep-all !important;
    }
    
    /* ê²°ì œ ë°©ë²• ì„ íƒ ì˜ì—­ ì „ì²´ ìŠ¤íƒ€ì¼ */
    #payment-method {
      min-height: 300px;
      overflow: visible;
    }
    
    /* ì•½ê´€ ë™ì˜ ì˜ì—­ ìŠ¤íƒ€ì¼ */
    #agreement {
      margin-top: 20px;
      min-height: 100px;
    }
    
    /* í† ìŠ¤ í˜ì´ë¨¼ì¸  ê·¸ë¦¬ë“œ ì»¬ëŸ¼ í¬ê¸° ì¡°ì • */
    .p-grid-col.p-grid-col3,
    #payment-method .p-grid-col.p-grid-col3 {
      width: 100% !important;
      flex: 1 1 100% !important;
      max-width: 100% !important;
      min-width: 200px !important;
    }
    
    /* ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ ì¡°ì • */
    .p-grid,
    #payment-method .p-grid {
      width: 100% !important;
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 8px !important;
    }
    
    /* êµ¬ë… ì˜µì…˜ ìŠ¤íƒ€ì¼ */
    .subscription-options {
      margin-bottom: 24px;
    }
    
    .option-card {
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .option-card:hover {
      border-color: #10b981;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1);
    }
    
    .option-card input[type="radio"] {
      display: none;
    }
    
    .option-card input[type="radio"]:checked + label {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      border-color: #10b981;
    }
    
    .option-card input[type="radio"]:checked + label::before {
      content: 'âœ“';
      position: absolute;
      top: 12px;
      right: 12px;
      width: 24px;
      height: 24px;
      background: #10b981;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    
    .option-card label {
      display: block;
      padding: 20px;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 10px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .option-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .option-title {
      font-size: 18px;
      font-weight: bold;
      color: #374151;
    }
    
    .option-price {
      font-size: 20px;
      font-weight: bold;
      color: #059669;
    }
    
    .option-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .monthly-price {
      font-size: 14px;
      color: #6b7280;
    }
    
    .discount-badge {
      background: #fbbf24;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .discount-badge.popular {
      background: #ef4444;
      position: relative;
    }
    
    .discount-badge.popular::after {
      content: 'ì¸ê¸°';
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc2626;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 8px;
      white-space: nowrap;
    }
    
    .savings {
      font-size: 12px;
      color: #059669;
      font-weight: bold;
      text-align: right;
    }
    
    .plan-features-section {
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="topbar">
    <div class="container topbar__row">
      <div class="logo">
        <a href="/" style="text-decoration: none; color: inherit;">
          <span>ğŸ§­</span>
          <span class="logo__title">ê³¨ëª©ìƒê¶Œ ë¹…ë°ì´í„° ë¶„ì„</span>
        </a>
      </div>
      <nav class="top-actions">
        <a href="/account" class="btn btn--ghost">ë‚´ ê³„ì •</a>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="payment-hero">
    <div class="container">
      <h1>ğŸ¯ í”„ë¦¬ë¯¸ì—„ êµ¬ë… ê²°ì œ</h1>
      <p>ë¬´ì œí•œ ìƒê¶Œ ë¶„ì„ìœ¼ë¡œ ì„±ê³µì ì¸ íˆ¬ìë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
    </div>
  </section>

  <!-- Main Content -->
  <div class="payment-container">
    <div class="payment-grid">
      
      <!-- Order Summary -->
      <div class="order-summary">
        <h2>ì£¼ë¬¸ ìš”ì•½</h2>
        
        <div class="subscription-options">
          <h3 style="margin-bottom: 24px; color: #374151;">êµ¬ë… ê¸°ê°„ ì„ íƒ</h3>
          
          <div class="option-card" data-duration="1" data-price="9500">
            <input type="radio" id="plan-1month" name="subscription-plan" value="1" checked>
            <label for="plan-1month">
              <div class="option-header">
                <span class="option-title">1ê°œì›”</span>
                <span class="option-price">â‚©9,500</span>
              </div>
              <div class="option-details">
                <span class="monthly-price">ì›” â‚©9,500</span>
              </div>
            </label>
          </div>
          
          <div class="option-card" data-duration="6" data-price="45600">
            <input type="radio" id="plan-6month" name="subscription-plan" value="6">
            <label for="plan-6month">
              <div class="option-header">
                <span class="option-title">6ê°œì›”</span>
                <span class="option-price">â‚©45,600</span>
              </div>
              <div class="option-details">
                <span class="monthly-price">ì›” â‚©7,600</span>
                <span class="discount-badge">20% í• ì¸</span>
              </div>
              <div class="savings">â‚©11,400 ì ˆì•½</div>
            </label>
          </div>
          
          <div class="option-card" data-duration="12" data-price="57000">
            <input type="radio" id="plan-12month" name="subscription-plan" value="12">
            <label for="plan-12month">
              <div class="option-header">
                <span class="option-title">12ê°œì›”</span>
                <span class="option-price">â‚©57,000</span>
              </div>
              <div class="option-details">
                <span class="monthly-price">ì›” â‚©4,750</span>
                <span class="discount-badge popular">50% í• ì¸</span>
              </div>
              <div class="savings">â‚©57,000 ì ˆì•½</div>
            </label>
          </div>
        </div>
        
        <div class="plan-features-section">
          <h4 style="margin: 20px 0 16px 0; color: #374151;">í¬í•¨ëœ ê¸°ëŠ¥</h4>
          <ul class="plan-features">
            <li>ë¬´ì œí•œ ë¶„ì„ ì¡°íšŒ</li>
            <li>ìƒì„¸ ì§€ì—­ë³„ ë¶„ì„</li>
            <li>AI íˆ¬ì ì¶”ì²œ</li>
            <li>ìœ„í—˜ë„ ë¶„ì„</li>
            <li>ë°ì´í„° ë‚´ë³´ë‚´ê¸°</li>
            <li>ìš°ì„  ê³ ê° ì§€ì›</li>
          </ul>
        </div>
        
        <div class="price-breakdown">
          <div class="price-row">
            <span id="plan-description">í”„ë¦¬ë¯¸ì—„ í”Œëœ (1ê°œì›”)</span>
            <span id="plan-price-display">â‚©9,500</span>
          </div>
          <div class="price-row" id="discount-row" style="display: none;">
            <span>í• ì¸</span>
            <span id="discount-amount">-â‚©0</span>
          </div>
          <div class="price-row">
            <span>êµ¬ë… ê¸°ê°„</span>
            <span id="subscription-period">ì˜¤ëŠ˜ë¶€í„° 1ê°œì›”</span>
          </div>
          <div class="price-row">
            <span>êµ¬ë… ë§Œë£Œì¼</span>
            <span id="expiry-date">ê³„ì‚° ì¤‘...</span>
          </div>
          <div class="price-row">
            <span>ë¶€ê°€ì„¸</span>
            <span>â‚©0</span>
          </div>
          <div class="price-row total">
            <span>ì´ ê²°ì œ ê¸ˆì•¡</span>
            <span id="total-amount">â‚©9,500</span>
          </div>
        </div>
        
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
          <h4 style="margin: 0 0 12px 0; color: #374151;">êµ¬ë… í˜œíƒ</h4>
          <p style="color: #6b7280; font-size: 14px; margin: 0;">
            â€¢ ì–¸ì œë“ ì§€ êµ¬ë…ì„ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
            â€¢ ì²« 7ì¼ê°„ ë¬´ë£Œ ì²´í—˜ (ì‹ ê·œ ê³ ê°)<br>
            â€¢ ì›” ì¤‘ í•´ì§€ ì‹œ ì¼í•  ê³„ì‚° í™˜ë¶ˆ
          </p>
        </div>
      </div>

      <!-- Payment Form -->
      <div class="payment-form">
        <h2>ê²°ì œ ì •ë³´</h2>

        <!-- í† ìŠ¤ í˜ì´ë¨¼ì¸  ìœ„ì ¯ -->
        <div id="payment-widget" class="payment-widget">
          <div class="loading">
            ê²°ì œ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...<br>
            <small id="loading-status" style="color: #6b7280; font-size: 12px;">SDK ë¡œë“œ í™•ì¸ ì¤‘</small>
          </div>
        </div>
        
        <!-- ê²°ì œ UI -->
        <div id="payment-method"></div>
        <!-- ì´ìš©ì•½ê´€ UI -->
        <div id="agreement"></div>
        
        <button id="payment-button" class="btn-payment" disabled>
          ê²°ì œí•˜ê¸° (<span id="payment-button-amount">â‚©9,500</span>)
        </button> 
        
        <div class="security-info">
          ğŸ”’ SSL ì•”í˜¸í™”ë¡œ ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤<br>
          í† ìŠ¤í˜ì´ë¨¼ì¸ ì˜ ì•ˆì „í•œ ê²°ì œ ì‹œìŠ¤í…œì„ ì‚¬ìš©í•©ë‹ˆë‹¤
        </div>
      </div>
    </div>
  </div>

  <script>
    // ë””ë²„ê¹… ë¡œê·¸ í•¨ìˆ˜
    function debugLog(step, data) {
      console.log(`[í† ìŠ¤í˜ì´ë¨¼ì¸ ] ${step}:`, data);
    }
    
    // êµ¬ë… ì˜µì…˜ ë°ì´í„°
    const subscriptionPlans = {
      1: { duration: 1, price: 9500, originalPrice: 9500, discount: 0, name: "1ê°œì›”" },
      6: { duration: 6, price: 45600, originalPrice: 57000, discount: 20, name: "6ê°œì›”" },
      12: { duration: 12, price: 57000, originalPrice: 114000, discount: 50, name: "12ê°œì›”" }
    };
    
    // í˜„ì¬ ì„ íƒëœ í”Œëœ (ê¸°ë³¸ê°’: 1ê°œì›”)
    let currentPlan = subscriptionPlans[1];
    
    // ê°€ê²© í¬ë§· í•¨ìˆ˜
    function formatPrice(price) {
      return 'â‚©' + price.toLocaleString();
    }
    
    // ë‚ ì§œ í¬ë§· í•¨ìˆ˜ (YYYYë…„ MMì›” DDì¼ í˜•ì‹)
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}ë…„ ${month}ì›” ${day}ì¼`;
    }
    
    // êµ¬ë… ë§Œë£Œì¼ ê³„ì‚° í•¨ìˆ˜
    function calculateExpiryDate(months) {
      const today = new Date();
      const expiryDate = new Date(today);
      expiryDate.setMonth(today.getMonth() + months);
      return expiryDate;
    }
    
    // êµ¬ë… ê¸°ê°„ í…ìŠ¤íŠ¸ ìƒì„± í•¨ìˆ˜
    function getSubscriptionPeriodText(months) {
      if (months === 1) {
        return 'ì˜¤ëŠ˜ë¶€í„° 1ê°œì›”';
      } else {
        return `ì˜¤ëŠ˜ë¶€í„° ${months}ê°œì›”`;
      }
    }
    
    // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updatePriceDisplay(planData) {
      // í”Œëœ ì„¤ëª… ì—…ë°ì´íŠ¸
      const planDescription = document.getElementById('plan-description');
      if (planDescription) {
        planDescription.textContent = `í”„ë¦¬ë¯¸ì—„ í”Œëœ (${planData.name})`;
      }
      
      // í”Œëœ ê°€ê²© ì—…ë°ì´íŠ¸
      const planPriceDisplay = document.getElementById('plan-price-display');
      if (planPriceDisplay) {
        planPriceDisplay.textContent = formatPrice(planData.price);
      }
      
      // í• ì¸ í–‰ í‘œì‹œ/ìˆ¨ê¹€
      const discountRow = document.getElementById('discount-row');
      const discountAmount = document.getElementById('discount-amount');
      if (planData.discount > 0) {
        if (discountRow) discountRow.style.display = 'flex';
        if (discountAmount) {
          const discountValue = planData.originalPrice - planData.price;
          discountAmount.textContent = '-' + formatPrice(discountValue);
        }
      } else {
        if (discountRow) discountRow.style.display = 'none';
      }
      
      // ì´ ê²°ì œ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
      const totalAmount = document.getElementById('total-amount');
      if (totalAmount) {
        totalAmount.textContent = formatPrice(planData.price);
      }
      
      // ê²°ì œ ë²„íŠ¼ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
      const paymentButtonAmount = document.getElementById('payment-button-amount');
      if (paymentButtonAmount) {
        paymentButtonAmount.textContent = formatPrice(planData.price);
      }
      
      // êµ¬ë… ê¸°ê°„ ì—…ë°ì´íŠ¸
      const subscriptionPeriod = document.getElementById('subscription-period');
      if (subscriptionPeriod) {
        subscriptionPeriod.textContent = getSubscriptionPeriodText(planData.duration);
      }
      
      // êµ¬ë… ë§Œë£Œì¼ ì—…ë°ì´íŠ¸
      const expiryDate = document.getElementById('expiry-date');
      if (expiryDate) {
        const expiryDateValue = calculateExpiryDate(planData.duration);
        expiryDate.textContent = formatDate(expiryDateValue);
      }
      
      // í† ìŠ¤ ìœ„ì ¯ ê¸ˆì•¡ ì—…ë°ì´íŠ¸
      await updateWidgetAmount(planData.price);
      
      debugLog('ê°€ê²© ì—…ë°ì´íŠ¸', {
        plan: planData.name,
        price: planData.price,
        discount: planData.discount,
        duration: planData.duration
      });
    }
    
    // êµ¬ë… ì˜µì…˜ ì„ íƒ ì´ë²¤íŠ¸ ì²˜ë¦¬
    function initSubscriptionOptions() {
      const radioButtons = document.querySelectorAll('input[name="subscription-plan"]');
      
      radioButtons.forEach(radio => {
        radio.addEventListener('change', async function() {
          if (this.checked) {
            const duration = parseInt(this.value);
            currentPlan = subscriptionPlans[duration];
            await updatePriceDisplay(currentPlan);
            debugLog('êµ¬ë… í”Œëœ ë³€ê²½', currentPlan);
          }
        });
      });
      
      debugLog('êµ¬ë… ì˜µì…˜ ì´ˆê¸°í™”', 'ì™„ë£Œ');
    }
    
    // customerKey ìƒì„± í•¨ìˆ˜
    function generateCustomerKey() {
      const key = 'customer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      debugLog('customerKey ìƒì„±', key);
      return key;
    }
    
    // orderId ìƒì„± í•¨ìˆ˜
    function generateOrderId() {
      // Django í…œí”Œë¦¿ì—ì„œ user_id ì¶”ì¶œ
      const userId = '{{ user.user_id|default:"" }}';
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 9);
      
      // user_idê°€ ìˆìœ¼ë©´ í¬í•¨, ì—†ìœ¼ë©´ ê¸°ë³¸ í˜•ì‹
      const orderId = userId ? `order_${userId}_${timestamp}_${random}` : `order_${timestamp}_${random}`;
      
      debugLog('orderId ìƒì„±', { orderId, userId, timestamp, random });
      return orderId;
    }
    
    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
      debugLog('ì˜¤ë¥˜ í‘œì‹œ', message);
    }
    
    // TossPayments SDK ë¡œë“œ í™•ì¸ í•¨ìˆ˜
    function checkTossPaymentsSDK() {
      if (typeof TossPayments === 'undefined') {
        throw new Error('TossPayments SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      }
      debugLog('TossPayments SDK ë¡œë“œ', 'ì„±ê³µ');
      return true;
    }
    
    // DOM ìš”ì†Œ ì¡´ì¬ í™•ì¸ í•¨ìˆ˜
    function checkRequiredElements() {
      const requiredElements = [
        'payment-method',
        'agreement', 
        'payment-button',
        'loading-status'
      ];
      
      for (const elementId of requiredElements) {
        const element = document.getElementById(elementId);
        if (!element) {
          throw new Error(`í•„ìˆ˜ DOM ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${elementId}`);
        }
      }
      debugLog('DOM ìš”ì†Œ ì²´í¬', 'ëª¨ë“  ìš”ì†Œ ì¡´ì¬');
      return true;
    }
    
    // í† ìŠ¤ ìœ„ì ¯ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© í•¨ìˆ˜
    function applyTossWidgetStyles() {
      debugLog('ìŠ¤íƒ€ì¼ ì ìš©', 'í† ìŠ¤ ìœ„ì ¯ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© ì‹œì‘');
      
      // MutationObserverë¡œ DOM ë³€í™” ê°ì§€í•˜ì—¬ ìŠ¤íƒ€ì¼ ì ìš©
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes.length > 0) {
            // p-grid-col3 ìš”ì†Œë“¤ ì°¾ì•„ì„œ ìŠ¤íƒ€ì¼ ì ìš©
            const gridCols = document.querySelectorAll('.p-grid-col3, [class*="p-grid-col3"]');
            gridCols.forEach(function(col) {
              col.style.width = '100%';
              col.style.flex = '1 1 100%';
              col.style.maxWidth = '100%';
              col.style.minWidth = '200px';
              debugLog('ìŠ¤íƒ€ì¼ ì ìš©', `p-grid-col3 ìš”ì†Œì— ìŠ¤íƒ€ì¼ ì ìš©: ${col.className}`);
            });
            
            // ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ì ìš©
            const grids = document.querySelectorAll('.p-grid, [class*="p-grid"]');
            grids.forEach(function(grid) {
              if (!grid.classList.contains('p-grid-col3')) {
                grid.style.width = '100%';
                grid.style.display = 'flex';
                grid.style.flexWrap = 'wrap';
                grid.style.gap = '8px';
                debugLog('ìŠ¤íƒ€ì¼ ì ìš©', `p-grid ìš”ì†Œì— ìŠ¤íƒ€ì¼ ì ìš©: ${grid.className}`);
              }
            });
            
            // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©
            const buttons = document.querySelectorAll('#payment-method button, #payment-method [role="button"]');
            buttons.forEach(function(btn) {
              btn.style.minHeight = '56px';
              btn.style.height = 'auto';
              btn.style.padding = '12px 16px';
              btn.style.whiteSpace = 'nowrap';
              btn.style.overflow = 'visible';
              btn.style.textOverflow = 'clip';
              debugLog('ìŠ¤íƒ€ì¼ ì ìš©', 'ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì ìš©');
            });
          }
        });
      });
      
      // payment-method ì˜ì—­ ê´€ì°° ì‹œì‘
      const paymentMethodArea = document.getElementById('payment-method');
      if (paymentMethodArea) {
        observer.observe(paymentMethodArea, {
          childList: true,
          subtree: true
        });
        
        // ì¦‰ì‹œ ì‹¤í–‰ë„ í•´ë³´ê¸°
        setTimeout(() => {
          const gridCols = paymentMethodArea.querySelectorAll('.p-grid-col3, [class*="p-grid-col3"]');
          gridCols.forEach(function(col) {
            col.style.width = '100%';
            col.style.flex = '1 1 100%';
            col.style.maxWidth = '100%';
            col.style.minWidth = '200px';
            debugLog('ìŠ¤íƒ€ì¼ ì ìš©', `ì¦‰ì‹œ ì ìš© - p-grid-col3: ${col.className}`);
          });
        }, 500);
        
        debugLog('ìŠ¤íƒ€ì¼ ì ìš©', 'MutationObserver ì„¤ì • ì™„ë£Œ');
      }
    }
    
    // ì „ì—­ ë³€ìˆ˜ë¡œ ìœ„ì ¯ ì €ì¥
    let tossPaymentsWidgets = null;
    
    // ìœ„ì ¯ ê¸ˆì•¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    async function updateWidgetAmount(amount) {
      if (tossPaymentsWidgets) {
        try {
          await tossPaymentsWidgets.setAmount({
            currency: "KRW",
            value: amount,
          });
          debugLog('ìœ„ì ¯ ê¸ˆì•¡ ì—…ë°ì´íŠ¸', `${amount}ì› ì„¤ì • ì„±ê³µ`);
        } catch (error) {
          debugLog('ìœ„ì ¯ ê¸ˆì•¡ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜', error);
        }
      }
    }
    
    // DOMì´ ë¡œë“œëœ í›„ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', async function() {
      debugLog('ì´ˆê¸°í™” ì‹œì‘', 'DOM ë¡œë“œ ì™„ë£Œ');
      
      try {
        // 0. êµ¬ë… ì˜µì…˜ ì´ˆê¸°í™”
        initSubscriptionOptions();
        
        // 0-1. ì´ˆê¸° êµ¬ë… ê¸°ê°„ ì •ë³´ ì„¤ì •
        await updatePriceDisplay(currentPlan);
        
        // 1. ì‚¬ì „ ì²´í¬
        checkTossPaymentsSDK();
        checkRequiredElements();
        
        // 2. ê²°ì œìœ„ì ¯ ì´ˆê¸°í™”
        debugLog('ì´ˆê¸°í™” ë‹¨ê³„', 'ê²°ì œìœ„ì ¯ ì´ˆê¸°í™” ì‹œì‘');
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        
        let tossPayments;
        try {
          tossPayments = TossPayments(clientKey);
          debugLog('TossPayments ì´ˆê¸°í™”', 'ì„±ê³µ');
        } catch (initError) {
          debugLog('TossPayments ì´ˆê¸°í™” ì˜¤ë¥˜', initError);
          throw new Error('í´ë¼ì´ì–¸íŠ¸ í‚¤ê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // 3. ìœ„ì ¯ ìƒì„±
        const customerKey = generateCustomerKey();
        try {
          tossPaymentsWidgets = tossPayments.widgets({ customerKey });
          debugLog('ìœ„ì ¯ ìƒì„±', 'ì„±ê³µ');
        } catch (widgetError) {
          debugLog('ìœ„ì ¯ ìƒì„± ì˜¤ë¥˜', widgetError);
          throw new Error('ê²°ì œ ìœ„ì ¯ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        // 4. ê²°ì œ ê¸ˆì•¡ ì„¤ì • (ì´ˆê¸°ê°’: 1ê°œì›” ê°€ê²©)
        try {
          await tossPaymentsWidgets.setAmount({
            currency: "KRW",
            value: currentPlan.price,
          });
          debugLog('ê¸ˆì•¡ ì„¤ì •', `${currentPlan.price}ì› ì„¤ì • ì„±ê³µ`);
        } catch (amountError) {
          debugLog('ê¸ˆì•¡ ì„¤ì • ì˜¤ë¥˜', amountError);
          throw new Error('ê²°ì œ ê¸ˆì•¡ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        // 5. ë¡œë”© ìƒíƒœ ì—…ë°ì´íŠ¸
        const loadingStatus = document.getElementById('loading-status');
        if (loadingStatus) {
          loadingStatus.textContent = 'ê²°ì œ UI ë Œë”ë§ ì¤‘...';
        }
        
        // 6. UI ë Œë”ë§
        try {
          await Promise.all([
            tossPaymentsWidgets.renderPaymentMethods({
              selector: "#payment-method",
              variantKey: "DEFAULT",
            }),
            tossPaymentsWidgets.renderAgreement({ 
              selector: "#agreement", 
              variantKey: "AGREEMENT" 
            }),
          ]);
          debugLog('UI ë Œë”ë§', 'ê²°ì œ UI ë° ì•½ê´€ ë Œë”ë§ ì„±ê³µ');
          
          // ë Œë”ë§ ì™„ë£Œ í›„ ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš©
          setTimeout(() => {
            applyTossWidgetStyles();
          }, 1000);
        } catch (renderError) {
          debugLog('UI ë Œë”ë§ ì˜¤ë¥˜', renderError);
          throw new Error('ê²°ì œ UI ë Œë”ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
        
        // 7. ë¡œë”© UI ìˆ¨ê¸°ê¸°
        const loadingElement = document.querySelector('.loading');
        if (loadingElement) {
          loadingElement.style.display = 'none';
          debugLog('UI ì—…ë°ì´íŠ¸', 'ë¡œë”© UI ìˆ¨ê¹€');
        }
        
        // 8. ê²°ì œ ë²„íŠ¼ í™œì„±í™”
        const paymentButton = document.getElementById('payment-button');
        if (paymentButton) {
          paymentButton.disabled = false;
          debugLog('UI ì—…ë°ì´íŠ¸', 'ê²°ì œ ë²„íŠ¼ í™œì„±í™”');
          
          // 9. ê²°ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
          paymentButton.addEventListener('click', async function() {
            debugLog('ê²°ì œ ìš”ì²­', 'ê²°ì œ ë²„íŠ¼ í´ë¦­');
            
            try {
              const orderId = generateOrderId();
              const paymentData = {
                orderId: orderId,
                orderName: `í”„ë¦¬ë¯¸ì—„ í”Œëœ ${currentPlan.name}`,
                successUrl: window.location.protocol + '//' + window.location.host + "/success",
                failUrl: window.location.protocol + '//' + window.location.host + "/fail",
                customerEmail: "test@example.com",
                customerName: "í…ŒìŠ¤íŠ¸ìœ ì €",
                customerMobilePhone: "01012345678",
              };
              
              debugLog('ê²°ì œ ë°ì´í„°', paymentData);
              
              await tossPaymentsWidgets.requestPayment(paymentData);
              debugLog('ê²°ì œ ìš”ì²­', 'ê²°ì œì°½ ëœ¨ì›€');
              
            } catch (paymentError) {
              debugLog('ê²°ì œ ìš”ì²­ ì˜¤ë¥˜', {
                message: paymentError.message,
                code: paymentError.code,
                stack: paymentError.stack
              });
              
              let errorMessage = 'ê²°ì œ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
              
              // ì˜¤ë¥˜ ì½”ë“œì— ë”°ë¥¸ ìƒì„¸ ë©”ì‹œì§€
              if (paymentError.code) {
                switch (paymentError.code) {
                  case 'UNAUTHORIZED_KEY':
                    errorMessage = 'ì¸ì¦ë˜ì§€ ì•Šì€ í´ë¼ì´ì–¸íŠ¸ í‚¤ì…ë‹ˆë‹¤.';
                    break;
                  case 'INVALID_REQUEST':
                    errorMessage = 'ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤. ê²°ì œ ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                    break;
                  case 'USER_CANCEL':
                    errorMessage = 'ì‚¬ìš©ìê°€ ê²°ì œë¥¼ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.';
                    break;
                  default:
                    errorMessage = `ê²°ì œ ì˜¤ë¥˜: ${paymentError.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
                }
              }
              
              showError(errorMessage);
            }
          });
        }
        
        debugLog('ì´ˆê¸°í™” ì™„ë£Œ', 'ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        
      } catch (error) {
        debugLog('ì´ˆê¸°í™” ì˜¤ë¥˜', {
          message: error.message,
          stack: error.stack
        });
        
        showError(error.message || 'ê²°ì œ ì‹œìŠ¤í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        
        const loadingElement = document.querySelector('.loading');
        if (loadingElement) {
          loadingElement.innerHTML = '<span style="color: #dc2626;">ê²°ì œ ì‹œìŠ¤í…œ ë¡œë“œ ì‹¤íŒ¨</span>';
        }
      }
    });
  </script>
</body>
</html>