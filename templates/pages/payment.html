{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>결제 - 골목상권 빅데이터 분석</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <script src="https://js.tosspayments.com/v2/standard"></script>
  
  <style>
    .payment-hero {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      color: white;
      padding: 60px 0;
      text-align: center;
    }
    
    .payment-container {
      max-width: 800px;
      margin: 40px auto;
      padding: 0 20px;
    }
    
    .payment-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      margin-top: 40px;
    }
    
    .order-summary {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      height: fit-content;
    }
    
    .payment-form {
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
    
    .plan-card {
      border: 2px solid #10b981;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
    }
    
    .plan-title {
      font-size: 24px;
      font-weight: bold;
      margin: 0 0 8px 0;
      color: #059669;
    }
    
    .plan-price {
      font-size: 32px;
      font-weight: bold;
      color: #047857;
      margin: 16px 0;
    }
    
    .plan-features {
      list-style: none;
      padding: 0;
      margin: 16px 0 0 0;
    }
    
    .plan-features li {
      padding: 8px 0;
      color: #374151;
      display: flex;
      align-items: center;
    }
    
    .plan-features li::before {
      content: "✓";
      color: #10b981;
      font-weight: bold;
      margin-right: 8px;
    }
    
    .price-breakdown {
      border-top: 1px solid #e5e7eb;
      padding-top: 20px;
      margin-top: 20px;
    }
    
    .price-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      color: #6b7280;
    }
    
    .price-row.total {
      border-top: 1px solid #e5e7eb;
      padding-top: 12px;
      margin-top: 12px;
      font-weight: bold;
      font-size: 18px;
      color: #111827;
    }
    
    .payment-widget {
      margin: 24px 0;
      min-height: 300px;
    }
    
    .btn-payment {
      width: 100%;
      background: #059669;
      color: white;
      border: none;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .btn-payment:hover {
      background: #047857;
    }
    
    .btn-payment:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    
    .security-info {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
      font-size: 14px;
      color: #6b7280;
      text-align: center;
    }
    
    .error-message {
      background: #fef2f2;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
      display: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px 0;
      color: #6b7280;
    }
    
    @media (max-width: 768px) {
      .payment-grid {
        grid-template-columns: 1fr;
        gap: 24px;
      }
    }
    
    /* 토스 페이먼츠 위젯 CSS 오버라이드 */
    #payment-method button,
    #payment-method [role="button"] {
      min-height: 56px !important;
      height: auto !important;
      padding: 12px 16px !important;
      white-space: nowrap !important;
      overflow: visible !important;
      text-overflow: clip !important;
    }
    
    /* 토스 페이먼츠 위젯 내부 요소 스타일 조정 */
    #payment-method .tosspayments-widget,
    #payment-method iframe {
      min-height: 300px !important;
    }
    
    /* 결제 수단 버튼 텍스트 스타일 */
    #payment-method button span,
    #payment-method [role="button"] span {
      font-size: 14px !important;
      line-height: 1.4 !important;
      word-break: keep-all !important;
    }
    
    /* 결제 방법 선택 영역 전체 스타일 */
    #payment-method {
      min-height: 300px;
      overflow: visible;
    }
    
    /* 약관 동의 영역 스타일 */
    #agreement {
      margin-top: 20px;
      min-height: 100px;
    }
    
    /* 토스 페이먼츠 그리드 컬럼 크기 조정 */
    .p-grid-col.p-grid-col3,
    #payment-method .p-grid-col.p-grid-col3 {
      width: 100% !important;
      flex: 1 1 100% !important;
      max-width: 100% !important;
      min-width: 200px !important;
    }
    
    /* 그리드 컨테이너 조정 */
    .p-grid,
    #payment-method .p-grid {
      width: 100% !important;
      display: flex !important;
      flex-wrap: wrap !important;
      gap: 8px !important;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="topbar">
    <div class="container topbar__row">
      <div class="logo">
        <a href="/" style="text-decoration: none; color: inherit;">
          <span>🧭</span>
          <span class="logo__title">골목상권 빅데이터 분석</span>
        </a>
      </div>
      <nav class="top-actions">
        <a href="/account" class="btn btn--ghost">내 계정</a>
      </nav>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="payment-hero">
    <div class="container">
      <h1>🎯 프리미엄 구독 결제</h1>
      <p>무제한 상권 분석으로 성공적인 투자를 시작하세요</p>
    </div>
  </section>

  <!-- Main Content -->
  <div class="payment-container">
    <div class="payment-grid">
      
      <!-- Order Summary -->
      <div class="order-summary">
        <h2>주문 요약</h2>
        
        <div class="plan-card">
          <h3 class="plan-title">프리미엄 플랜</h3>
          <div class="plan-price">
            ₩9,500
            <span style="font-size: 16px; color: #6b7280;">/월</span>
          </div>
          
          <ul class="plan-features">
            <li>무제한 분석 조회</li>
            <li>상세 지역별 분석</li>
            <li>AI 투자 추천</li>
            <li>위험도 분석</li>
            <li>데이터 내보내기</li>
            <li>우선 고객 지원</li>
          </ul>
        </div>
        
        <div class="price-breakdown">
          <div class="price-row">
            <span>프리미엄 플랜 (1개월)</span>
            <span>₩9,500</span>
          </div>
          <div class="price-row">
            <span>부가세</span>
            <span>₩0</span>
          </div>
          <div class="price-row total">
            <span>총 결제 금액</span>
            <span>₩9,500</span>
          </div>
        </div>
        
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
          <h4 style="margin: 0 0 12px 0; color: #374151;">구독 혜택</h4>
          <p style="color: #6b7280; font-size: 14px; margin: 0;">
            • 언제든지 구독을 취소할 수 있습니다<br>
            • 첫 7일간 무료 체험 (신규 고객)<br>
            • 월 중 해지 시 일할 계산 환불
          </p>
        </div>
      </div>

      <!-- Payment Form -->
      <div class="payment-form">
        <h2>결제 정보</h2>

        <!-- 토스 페이먼츠 위젯 -->
        <div id="payment-widget" class="payment-widget">
          <div class="loading">
            결제 모듈을 불러오는 중...<br>
            <small id="loading-status" style="color: #6b7280; font-size: 12px;">SDK 로드 확인 중</small>
          </div>
        </div>
        
        <!-- 결제 UI -->
        <div id="payment-method"></div>
        <!-- 이용약관 UI -->
        <div id="agreement"></div>
        
        <button id="payment-button" class="btn-payment" disabled>
          결제하기 (₩9,500)
        </button> 
        
        <div class="security-info">
          🔒 SSL 암호화로 안전하게 보호됩니다<br>
          토스페이먼츠의 안전한 결제 시스템을 사용합니다
        </div>
      </div>
    </div>
  </div>

  <script>
    // 디버깅 로그 함수
    function debugLog(step, data) {
      console.log(`[토스페이먼츠] ${step}:`, data);
    }
    
    // customerKey 생성 함수
    function generateCustomerKey() {
      const key = 'customer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      debugLog('customerKey 생성', key);
      return key;
    }
    
    // orderId 생성 함수
    function generateOrderId() {
      // Django 템플릿에서 user_id 추출
      const userId = '{{ user.user_id|default:"" }}';
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 9);
      
      // user_id가 있으면 포함, 없으면 기본 형식
      const orderId = userId ? `order_${userId}_${timestamp}_${random}` : `order_${timestamp}_${random}`;
      
      debugLog('orderId 생성', { orderId, userId, timestamp, random });
      return orderId;
    }
    
    // 에러 메시지 표시 함수
    function showError(message) {
      const errorElement = document.getElementById('error-message');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = 'block';
      }
      debugLog('오류 표시', message);
    }
    
    // TossPayments SDK 로드 확인 함수
    function checkTossPaymentsSDK() {
      if (typeof TossPayments === 'undefined') {
        throw new Error('TossPayments SDK가 로드되지 않았습니다.');
      }
      debugLog('TossPayments SDK 로드', '성공');
      return true;
    }
    
    // DOM 요소 존재 확인 함수
    function checkRequiredElements() {
      const requiredElements = [
        'payment-method',
        'agreement', 
        'payment-button',
        'loading-status'
      ];
      
      for (const elementId of requiredElements) {
        const element = document.getElementById(elementId);
        if (!element) {
          throw new Error(`필수 DOM 요소를 찾을 수 없습니다: ${elementId}`);
        }
      }
      debugLog('DOM 요소 체크', '모든 요소 존재');
      return true;
    }
    
    // 토스 위젯 스타일 강제 적용 함수
    function applyTossWidgetStyles() {
      debugLog('스타일 적용', '토스 위젯 스타일 강제 적용 시작');
      
      // MutationObserver로 DOM 변화 감지하여 스타일 적용
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.addedNodes.length > 0) {
            // p-grid-col3 요소들 찾아서 스타일 적용
            const gridCols = document.querySelectorAll('.p-grid-col3, [class*="p-grid-col3"]');
            gridCols.forEach(function(col) {
              col.style.width = '100%';
              col.style.flex = '1 1 100%';
              col.style.maxWidth = '100%';
              col.style.minWidth = '200px';
              debugLog('스타일 적용', `p-grid-col3 요소에 스타일 적용: ${col.className}`);
            });
            
            // 그리드 컨테이너 스타일 적용
            const grids = document.querySelectorAll('.p-grid, [class*="p-grid"]');
            grids.forEach(function(grid) {
              if (!grid.classList.contains('p-grid-col3')) {
                grid.style.width = '100%';
                grid.style.display = 'flex';
                grid.style.flexWrap = 'wrap';
                grid.style.gap = '8px';
                debugLog('스타일 적용', `p-grid 요소에 스타일 적용: ${grid.className}`);
              }
            });
            
            // 버튼 스타일 적용
            const buttons = document.querySelectorAll('#payment-method button, #payment-method [role="button"]');
            buttons.forEach(function(btn) {
              btn.style.minHeight = '56px';
              btn.style.height = 'auto';
              btn.style.padding = '12px 16px';
              btn.style.whiteSpace = 'nowrap';
              btn.style.overflow = 'visible';
              btn.style.textOverflow = 'clip';
              debugLog('스타일 적용', '버튼 스타일 적용');
            });
          }
        });
      });
      
      // payment-method 영역 관찰 시작
      const paymentMethodArea = document.getElementById('payment-method');
      if (paymentMethodArea) {
        observer.observe(paymentMethodArea, {
          childList: true,
          subtree: true
        });
        
        // 즉시 실행도 해보기
        setTimeout(() => {
          const gridCols = paymentMethodArea.querySelectorAll('.p-grid-col3, [class*="p-grid-col3"]');
          gridCols.forEach(function(col) {
            col.style.width = '100%';
            col.style.flex = '1 1 100%';
            col.style.maxWidth = '100%';
            col.style.minWidth = '200px';
            debugLog('스타일 적용', `즉시 적용 - p-grid-col3: ${col.className}`);
          });
        }, 500);
        
        debugLog('스타일 적용', 'MutationObserver 설정 완료');
      }
    }
    
    // DOM이 로드된 후 실행
    document.addEventListener('DOMContentLoaded', async function() {
      debugLog('초기화 시작', 'DOM 로드 완료');
      
      try {
        // 1. 사전 체크
        checkTossPaymentsSDK();
        checkRequiredElements();
        
        // 2. 결제위젯 초기화
        debugLog('초기화 단계', '결제위젯 초기화 시작');
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        
        let tossPayments;
        try {
          tossPayments = TossPayments(clientKey);
          debugLog('TossPayments 초기화', '성공');
        } catch (initError) {
          debugLog('TossPayments 초기화 오류', initError);
          throw new Error('클라이언트 키가 잘못되었거나 만료되었습니다.');
        }
        
        // 3. 위젯 생성
        const customerKey = generateCustomerKey();
        let widgets;
        try {
          widgets = tossPayments.widgets({ customerKey });
          debugLog('위젯 생성', '성공');
        } catch (widgetError) {
          debugLog('위젯 생성 오류', widgetError);
          throw new Error('결제 위젯 생성에 실패했습니다.');
        }
        
        // 4. 결제 금액 설정
        try {
          await widgets.setAmount({
            currency: "KRW",
            value: 9500,
          });
          debugLog('금액 설정', '9500원 설정 성공');
        } catch (amountError) {
          debugLog('금액 설정 오류', amountError);
          throw new Error('결제 금액 설정에 실패했습니다.');
        }
        
        // 5. 로딩 상태 업데이트
        const loadingStatus = document.getElementById('loading-status');
        if (loadingStatus) {
          loadingStatus.textContent = '결제 UI 렌더링 중...';
        }
        
        // 6. UI 렌더링
        try {
          await Promise.all([
            widgets.renderPaymentMethods({
              selector: "#payment-method",
              variantKey: "DEFAULT",
            }),
            widgets.renderAgreement({ 
              selector: "#agreement", 
              variantKey: "AGREEMENT" 
            }),
          ]);
          debugLog('UI 렌더링', '결제 UI 및 약관 렌더링 성공');
          
          // 렌더링 완료 후 스타일 강제 적용
          setTimeout(() => {
            applyTossWidgetStyles();
          }, 1000);
        } catch (renderError) {
          debugLog('UI 렌더링 오류', renderError);
          throw new Error('결제 UI 렌더링에 실패했습니다.');
        }
        
        // 7. 로딩 UI 숨기기
        const loadingElement = document.querySelector('.loading');
        if (loadingElement) {
          loadingElement.style.display = 'none';
          debugLog('UI 업데이트', '로딩 UI 숨김');
        }
        
        // 8. 결제 버튼 활성화
        const paymentButton = document.getElementById('payment-button');
        if (paymentButton) {
          paymentButton.disabled = false;
          debugLog('UI 업데이트', '결제 버튼 활성화');
          
          // 9. 결제 버튼 이벤트 리스너 등록
          paymentButton.addEventListener('click', async function() {
            debugLog('결제 요청', '결제 버튼 클릭');
            
            try {
              const orderId = generateOrderId();
              const paymentData = {
                orderId: orderId,
                orderName: "프리미엄 플랜 1개월",
                successUrl: window.location.protocol + '//' + window.location.host + "/success",
                failUrl: window.location.protocol + '//' + window.location.host + "/fail",
                customerEmail: "test@example.com",
                customerName: "테스트유저",
                customerMobilePhone: "01012345678",
              };
              
              debugLog('결제 데이터', paymentData);
              
              await widgets.requestPayment(paymentData);
              debugLog('결제 요청', '결제창 뜨움');
              
            } catch (paymentError) {
              debugLog('결제 요청 오류', {
                message: paymentError.message,
                code: paymentError.code,
                stack: paymentError.stack
              });
              
              let errorMessage = '결제 요청 중 오류가 발생했습니다.';
              
              // 오류 코드에 따른 상세 메시지
              if (paymentError.code) {
                switch (paymentError.code) {
                  case 'UNAUTHORIZED_KEY':
                    errorMessage = '인증되지 않은 클라이언트 키입니다.';
                    break;
                  case 'INVALID_REQUEST':
                    errorMessage = '잘못된 요청입니다. 결제 정보를 확인해주세요.';
                    break;
                  case 'USER_CANCEL':
                    errorMessage = '사용자가 결제를 취소했습니다.';
                    break;
                  default:
                    errorMessage = `결제 오류: ${paymentError.message || '알 수 없는 오류'}`;
                }
              }
              
              showError(errorMessage);
            }
          });
        }
        
        debugLog('초기화 완료', '모든 설정이 완료되었습니다.');
        
      } catch (error) {
        debugLog('초기화 오류', {
          message: error.message,
          stack: error.stack
        });
        
        showError(error.message || '결제 시스템을 불러오는 중 오류가 발생했습니다.');
        
        const loadingElement = document.querySelector('.loading');
        if (loadingElement) {
          loadingElement.innerHTML = '<span style="color: #dc2626;">결제 시스템 로드 실패</span>';
        }
      }
    });
  </script>
</body>
</html>