{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>회원가입 - 골목상권 빅데이터 분석</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <style>
    .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .login-card { background: white; padding: 48px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; }
    .login-header { text-align: center; margin-bottom: 32px; }
    .login-header h1 { margin: 0 0 8px 0; font-size: 28px; color: #374151; }
    .login-header p { margin: 0; color: #6b7280; font-size: 14px; }
    .field { margin-bottom: 20px; }
    .field label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; font-size: 14px; }
    .field input { width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; transition: border-color 0.2s; box-sizing: border-box; }
    .field input:focus { outline: none; border-color: #3b82f6; }
    .login-btn { width: 100%; padding: 14px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
    .login-btn:hover { background: #2563eb; }
    .login-btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .back-link { text-align: center; margin-top: 24px; }
    .back-link a { color: #6b7280; text-decoration: none; font-size: 14px; }
    .back-link a:hover { color: #374151; }
    .error-message { color: #dc2626; font-size: 12px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-card">
      <div class="login-header">
        <h1>🚀 회원가입</h1>
        <p>골목상권 빅데이터 분석 서비스 시작하기</p>
      </div>
      
      <form id="registerForm">
        {% csrf_token %}
        <div class="field">
          <label for="username">사용자 이름</label>
          <input type="text" id="username" name="username" required>
          <div class="error-message" id="error-username"></div>
        </div>

        <div class="field">
          <label for="email">이메일</label>
          <input type="email" id="email" name="email" required>
          <div class="error-message" id="error-email"></div>
        </div>
        
        <div class="field">
          <label for="password">비밀번호</label>
          <input type="password" id="password" name="password" required>
          <div class="error-message" id="error-password"></div>
        </div>

        <div class="field">
          <label for="password2">비밀번호 확인</label>
          <input type="password" id="password2" name="password2" required>
          <div class="error-message" id="error-password2"></div>
        </div>
        
        <button type="submit" class="login-btn" id="btnRegister">가입하기</button>
      </form>
      
      <div class="back-link">
        <a href="{% url 'login' %}">← 이미 계정이 있으신가요? 로그인</a>
      </div>
    </div>
  </div>

  <script>
    class RegisterPage {
      constructor() {
        this.form = document.getElementById('registerForm');
        this.btnRegister = document.getElementById('btnRegister');
        this.initializeEvents();
      }

      getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
      }
      
      initializeEvents() {
        this.form.addEventListener('submit', async (e) => {
          e.preventDefault();
          await this.register();
        });
      }

      clearErrors() {
          document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
      }

      displayErrors(errors) {
          this.clearErrors();
          for (const [field, messages] of Object.entries(errors)) {
              const errorEl = document.getElementById(`error-${field}`);
              if (errorEl) {
                  errorEl.textContent = messages.join(' ');
              }
          }
      }
      
      async register() {
        this.clearErrors();
        const formData = new FormData(this.form);
        const data = Object.fromEntries(formData.entries());

        this.btnRegister.disabled = true;
        this.btnRegister.textContent = '가입 중...';

        try {
          const response = await fetch('/api/accounts/users/register/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': this.getCookie('csrftoken')
            },
            body: JSON.stringify(data)
          });

          const result = await response.json();

          if (response.ok && result.success) {
            alert('회원가입에 성공했습니다! 메인 페이지로 이동합니다.');
            window.location.href = '/';
          } else if (result.errors) {
            this.displayErrors(result.errors);
          } else {
            alert('알 수 없는 오류가 발생했습니다.');
          }

        } catch (error) {
          console.error('회원가입 실패:', error);
          alert('회원가입 중 오류가 발생했습니다.');
        } finally {
          this.btnRegister.disabled = false;
          this.btnRegister.textContent = '가입하기';
        }
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      new RegisterPage();
    });
  </script>
</body>
</html>
