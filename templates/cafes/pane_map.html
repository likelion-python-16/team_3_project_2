{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì§€ë„ ë¶„ì„</title>
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <style>
    /* KPI í´ë¦­ ê°€ëŠ¥ ìŠ¤íƒ€ì¼ */
    .kpi .v {
      cursor: pointer;
      transition: all 0.2s ease;
      border-radius: 4px;
      padding: 2px 4px;
    }
    
    .kpi .v:hover {
      background-color: #f3f4f6;
      transform: scale(1.05);
    }
    
    /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
    .analysis-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    
    .analysis-modal-overlay.active {
      display: flex;
    }
    
    /* ëª¨ë‹¬ ì»¨í…Œì´ë„ˆ */
    .analysis-modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* ëª¨ë‹¬ í—¤ë” */
    .analysis-modal-header {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
      padding: 20px 24px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .analysis-modal-title {
      font-size: 20px;
      font-weight: bold;
      margin: 0;
    }
    
    .analysis-modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s ease;
    }
    
    .analysis-modal-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* ëª¨ë‹¬ ë‚´ìš© */
    .analysis-modal-content {
      padding: 24px;
    }
    
    /* í”¼ë“œ ì¹´ë“œ ìŠ¤íƒ€ì¼ (summary.htmlê³¼ ë™ì¼) */
    .feed-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #3b82f6;
    }
    
    .feed-card h3 {
      margin: 0 0 12px 0;
      color: #1f2937;
    }
    
    .feed-meta {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .feed-content {
      color: #374151;
      line-height: 1.6;
      margin-bottom: 16px;
    }
    
    .highlight-stat {
      background: #f3f4f6;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .stat-label {
      font-weight: 500;
      color: #374151;
    }
    
    .stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #059669;
    }
    
    .stat-value.warning {
      color: #d97706;
    }
    
    .stat-value.danger {
      color: #dc2626;
    }
    
    .trending-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .trending-list li {
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .trending-list li:last-child {
      border-bottom: none;
    }
    
    .trend-up {
      color: #059669;
    }
    
    .trend-down {
      color: #dc2626;
    }
    
    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="card tab-pane" id="pane-map" style="position: relative;">
    <div class="card__head">
      <h3>ì¹´í˜ ìƒê¶Œ ì§€ë„ <span class="tag">ì¹´í˜ ì—…ì¢… ë¶„ì„ ê²°ê³¼</span></h3>
      <div class="legend">
        <span class="dot g"></span><small class="muted">ì•ˆì •</small>
        <span class="dot y"></span><small class="muted">ì£¼ì˜</small>
        <span class="dot r"></span><small class="muted">ìœ„í—˜</small>
      </div>
    </div>
    <div id="map" class="map"></div>
    <div class="grid-4 kpi-grid">
      <div class="kpi"><div class="t">í‘œì‹œëœ ìƒê¶Œ ìˆ˜</div><div class="v" id="k_cnt">{{ total_count }}</div></div>
      <div class="kpi"><div class="t">ì „ì²´ ì‚¬ì—…ì</div><div class="v">{{ total_businesses_by_region }}</div></div>
      <div class="kpi"><div class="t">í‰ê·  ì„±ì¥ë¥ </div><div class="v up">{{ avg_growth_rate }}</div><div class="s">ì„ íƒí•œ ì§€ì—­ í‰ê· </div></div>
      <div class="kpi"><div class="t">ìœ„í—˜ ì§€ì—­</div><div class="v warn">{{ risk_areas_count }}</div></div>
    </div>
  </div>

  <!-- ë¶„ì„ ëª¨ë‹¬ -->
  <div class="analysis-modal-overlay" id="analysisModal">
    <div class="analysis-modal">
      <div class="analysis-modal-header">
        <h2 class="analysis-modal-title" id="modalTitle">ìƒì„¸ ë¶„ì„</h2>
        <button class="analysis-modal-close" onclick="closeAnalysisModal()">&times;</button>
      </div>
      <div class="analysis-modal-content" id="modalContent">
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
      </div>
    </div>
  </div>
</body>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dd7894cd5f31c782972ae169dec652f6"></script>
  <script type="text/javascript">
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì§€ì—­ ì •ë³´ ì½ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    let selectedRegion = urlParams.get('region') || 'ì„œìš¸ì‹œ ì „ì²´';
    let selectedMajorCategory = urlParams.get('major_category') || 'type_all';
    let selectedMidCategory = urlParams.get('mid_category') || 'ì „ì²´';
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', () => {
      updatePageTitle();
      moveToRegionCenter(selectedRegion); // ì´ˆê¸° ì§€ì—­ì— ë§ê²Œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
      loadCafeMarkers(); // ì´ˆê¸° ì¹´í˜ ë§ˆì»¤ ë¡œë“œ
    });

    // ë¶€ëª¨ ì°½ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'FILTER_UPDATE') {
        console.log('ì§€ë„ iframe: í•„í„° ì—…ë°ì´íŠ¸ ë©”ì‹œì§€ ìˆ˜ì‹ ', event.data.filters);
        
        // í•„í„° ê°’ ì—…ë°ì´íŠ¸
        selectedRegion = event.data.filters.region || 'ì„œìš¸ì‹œ ì „ì²´';
        selectedMajorCategory = event.data.filters.major_category || 'type_all';
        selectedMidCategory = event.data.filters.mid_category || 'ì „ì²´';
        
        // UI ì—…ë°ì´íŠ¸
        updatePageTitle();
        updateKPIValues();
        
        // ì§€ì—­ ë³€ê²½ ì‹œ ì§€ë„ ì¤‘ì‹¬ ì´ë™
        moveToRegionCenter(selectedRegion);
        
        // ì¹´í˜ ë§ˆì»¤ ë‹¤ì‹œ ë¡œë”©
        loadCafeMarkers();
      }
    });

    // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
    function updatePageTitle() {
      const cardHeadTitle = document.querySelector('.card__head h3');
      if (cardHeadTitle) {
        cardHeadTitle.innerHTML = `${selectedRegion} ìƒê¶Œ ì§€ë„ <span class="tag">ì¹´í˜ ì—…ì¢… ë¶„ì„ ê²°ê³¼</span>`;
      }
    }

    // KPI ê°’ ì—…ë°ì´íŠ¸
    function updateKPIValues() {
      const params = new URLSearchParams();
      
      if (selectedRegion && selectedRegion !== 'ì„œìš¸ì‹œ ì „ì²´') {
        params.append('region', selectedRegion);
      }
      if (selectedMajorCategory && selectedMajorCategory !== 'type_all') {
        params.append('major_category', selectedMajorCategory);
      }
      if (selectedMidCategory && selectedMidCategory !== 'ì „ì²´') {
        params.append('mid_category', selectedMidCategory);
      }
      
      const apiUrl = `/api/cafes/cafes/region_stats/?${params.toString()}`;
      console.log('ì§€ë„ iframe: KPI ì—…ë°ì´íŠ¸ API í˜¸ì¶œ', apiUrl);
      
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('ì§€ë„ iframe: KPI ë°ì´í„° ìˆ˜ì‹ ', data);
          updateKPIDisplay(data);
        })
        .catch(error => {
          console.error('ì§€ë„ iframe: KPI ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
        });
    }

    // KPI í™”ë©´ ì—…ë°ì´íŠ¸
    function updateKPIDisplay(data) {
      const kCntElement = document.getElementById('k_cnt');
      if (kCntElement) {
        kCntElement.textContent = data.total_stores || 0;
      }
      
      // ë‹¤ë¥¸ KPI ìš”ì†Œë“¤ë„ ì—…ë°ì´íŠ¸
      const kpiElements = document.querySelectorAll('.kpi .v');
      if (kpiElements.length >= 3) {
        // í‰ê·  ì„±ì¥ë¥  ì—…ë°ì´íŠ¸ (ì„¸ ë²ˆì§¸ .v ìš”ì†Œ)
        if (kpiElements[2]) {
          kpiElements[2].textContent = data.growth_rate || '0%';
        }
        // ìœ„í—˜ ì§€ì—­ ì—…ë°ì´íŠ¸ (ë„¤ ë²ˆì§¸ .v ìš”ì†Œ)
        if (kpiElements[3]) {
          kpiElements[3].textContent = data.risk_areas_count || 0;
        }
      }
    }

    // ì„œìš¸ì‹œ ê° êµ¬ë³„ ì¤‘ì‹¬ ì¢Œí‘œ
    const seoulDistrictCoordinates = {
      'ê°•ë‚¨êµ¬': { lat: 37.4979, lng: 127.0276, level: 6 },
      'ê°•ë™êµ¬': { lat: 37.5301, lng: 127.1238, level: 6 },
      'ê°•ë¶êµ¬': { lat: 37.6398, lng: 127.0256, level: 6 },
      'ê°•ì„œêµ¬': { lat: 37.5509, lng: 126.8495, level: 6 },
      'ê´€ì•…êµ¬': { lat: 37.4784, lng: 126.9514, level: 6 },
      'ê´‘ì§„êµ¬': { lat: 37.5385, lng: 127.0822, level: 6 },
      'êµ¬ë¡œêµ¬': { lat: 37.4955, lng: 126.8873, level: 6 },
      'ê¸ˆì²œêµ¬': { lat: 37.4593, lng: 126.9003, level: 6 },
      'ë…¸ì›êµ¬': { lat: 37.6542, lng: 127.0568, level: 6 },
      'ë„ë´‰êµ¬': { lat: 37.6688, lng: 127.0471, level: 6 },
      'ë™ëŒ€ë¬¸êµ¬': { lat: 37.5836, lng: 127.0544, level: 6 },
      'ë™ì‘êµ¬': { lat: 37.4971, lng: 126.9395, level: 6 },
      'ë§ˆí¬êµ¬': { lat: 37.5663, lng: 126.9019, level: 6 },
      'ì„œëŒ€ë¬¸êµ¬': { lat: 37.5794, lng: 126.9368, level: 6 },
      'ì„œì´ˆêµ¬': { lat: 37.4737, lng: 127.0324, level: 6 },
      'ì„±ë™êµ¬': { lat: 37.5636, lng: 127.0369, level: 6 },
      'ì„±ë¶êµ¬': { lat: 37.6027, lng: 127.0167, level: 6 },
      'ì†¡íŒŒêµ¬': { lat: 37.5145, lng: 127.1059, level: 6 },
      'ì–‘ì²œêµ¬': { lat: 37.5270, lng: 126.8561, level: 6 },
      'ì˜ë“±í¬êµ¬': { lat: 37.5264, lng: 126.8962, level: 6 },
      'ìš©ì‚°êµ¬': { lat: 37.5311, lng: 126.9810, level: 6 },
      'ì€í‰êµ¬': { lat: 37.6176, lng: 126.9227, level: 6 },
      'ì¢…ë¡œêµ¬': { lat: 37.5735, lng: 126.9788, level: 6 },
      'ì¤‘êµ¬': { lat: 37.5640, lng: 126.9970, level: 6 },
      'ì¤‘ë‘êµ¬': { lat: 37.6063, lng: 127.0925, level: 6 }
    };

    var container = document.getElementById('map'); //ì§€ë„ë¥¼ ë‹´ì„ ì˜ì—­ì˜ DOM ë ˆí¼ëŸ°ìŠ¤
    var options = { //ì§€ë„ë¥¼ ìƒì„±í•  ë•Œ í•„ìš”í•œ ê¸°ë³¸ ì˜µì…˜
      center: new kakao.maps.LatLng(37.5665, 126.9780), //ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ (ì„œìš¸ì‹œì²­)
      level: 8 //ì§€ë„ì˜ ë ˆë²¨(í™•ëŒ€, ì¶•ì†Œ ì •ë„)
    };
  
    var map = new kakao.maps.Map(container, options); //ì§€ë„ ìƒì„± ë° ê°ì²´ ë¦¬í„´
    
    // ë§ˆì»¤ ê´€ë ¨ ë³€ìˆ˜ë“¤
    var markers = []; // í˜„ì¬ í‘œì‹œëœ ë§ˆì»¤ë“¤
    var infoWindow = new kakao.maps.InfoWindow({zIndex:1}); // ì •ë³´ì°½
    
    // ëª¨ë“  ë§ˆì»¤ ì œê±°
    function clearMarkers() {
      markers.forEach(marker => {
        marker.setMap(null);
      });
      markers = [];
      infoWindow.close();
    }
    
    // ì§€ì—­ë³„ ì§€ë„ ì¤‘ì‹¬ ì´ë™ í•¨ìˆ˜
    function moveToRegionCenter(regionName) {
      if (!regionName || regionName === 'ì„œìš¸ì‹œ ì „ì²´') {
        // ì„œìš¸ì‹œ ì „ì²´ ì„ íƒ ì‹œ ì„œìš¸ì‹œì²­ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
        const center = new kakao.maps.LatLng(37.5665, 126.9780);
        map.setCenter(center);
        map.setLevel(8); // ì„œìš¸ì‹œ ì „ì²´ê°€ ë³´ì´ëŠ” ë ˆë²¨
        console.log('ì„œìš¸ì‹œ ì „ì²´ ì§€ë„ë¡œ ì´ë™');
      } else {
        // íŠ¹ì • êµ¬ ì„ íƒ ì‹œ í•´ë‹¹ êµ¬ ì¤‘ì‹¬ìœ¼ë¡œ ì´ë™
        const districtInfo = seoulDistrictCoordinates[regionName];
        if (districtInfo) {
          const center = new kakao.maps.LatLng(districtInfo.lat, districtInfo.lng);
          map.setCenter(center);
          map.setLevel(districtInfo.level);
          console.log(`${regionName} ì§€ë„ë¡œ ì´ë™: ${districtInfo.lat}, ${districtInfo.lng}`);
        } else {
          console.warn(`${regionName}ì— í•´ë‹¹í•˜ëŠ” ì¢Œí‘œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }
      }
    }
    
    // ê°œë³„ ì¹´í˜ ë§ˆì»¤ ìƒì„±
    function createCafeMarker(cafe) {
      const position = new kakao.maps.LatLng(cafe.latitude, cafe.longitude);
      
      // ìƒíƒœë³„ ë§ˆì»¤ ì´ë¯¸ì§€ ì„¤ì •
      const markerImage = createMarkerImage(cafe.status);
      
      // ë§ˆì»¤ ìƒì„±
      const marker = new kakao.maps.Marker({
        position: position,
        image: markerImage,
        title: cafe.name
      });
      
      marker.setMap(map);
      markers.push(marker);
      
      // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
      kakao.maps.event.addListener(marker, 'click', function() {
        showCafeInfo(cafe, marker);
      });
    }
    
    // ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„± í•¨ìˆ˜
    function createMarkerImage(status) {
      const color = getMarkerColor(status);
      const imageSize = new kakao.maps.Size(24, 35);
      const imageOption = {offset: new kakao.maps.Point(12, 35)};
      
      // SVGë¥¼ ì´ìš©í•œ ë§ˆì»¤ ì´ë¯¸ì§€ ìƒì„±
      const svgMarker = `
        <svg width="24" height="35" viewBox="0 0 24 35" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 0C5.4 0 0 5.4 0 12c0 8.4 12 23 12 23s12-14.6 12-23c0-6.6-5.4-12-12-12z" fill="${color}"/>
          <circle cx="12" cy="12" r="6" fill="white"/>
        </svg>
      `;
      
      const imageSrc = 'data:image/svg+xml;base64,' + btoa(svgMarker);
      
      return new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
    }
    
    // ìƒíƒœë³„ ë§ˆì»¤ ìƒ‰ìƒ ë°˜í™˜
    function getMarkerColor(status) {
      const colorMap = {
        'safe': '#10b981',    // ì´ˆë¡ìƒ‰ (ì•ˆì •)
        'warning': '#f59e0b', // ë…¸ë€ìƒ‰ (ì£¼ì˜)
        'risk': '#ef4444'     // ë¹¨ê°„ìƒ‰ (ìœ„í—˜)
      };
      return colorMap[status] || '#6b7280'; // ê¸°ë³¸ê°’: íšŒìƒ‰
    }
    
    // ì¹´í˜ ì •ë³´ë¥¼ ì •ë³´ì°½ìœ¼ë¡œ í‘œì‹œ
    function showCafeInfo(cafe, marker) {
      const content = `
        <div style="padding:10px; min-width:200px;">
          <div style="font-weight:bold; margin-bottom:5px;">${cafe.name}</div>
          <div style="font-size:12px; color:#666; margin-bottom:3px;">
            ${cafe.franchise ? 'í”„ëœì°¨ì´ì¦ˆ' : 'ê°œì¸ì¹´í˜'}
          </div>
          <div style="font-size:12px; color:#666; margin-bottom:3px;">${cafe.detail_address}</div>
          <div style="margin-top:8px;">
            <span style="padding:2px 6px; border-radius:4px; font-size:11px; color:white; background-color:${getMarkerColor(cafe.status)};">
              ${getStatusText(cafe.status)}
            </span>
          </div>
        </div>
      `;
      
      infoWindow.setContent(content);
      infoWindow.open(map, marker);
    }
    
    // ìƒíƒœ í…ìŠ¤íŠ¸ ë°˜í™˜
    function getStatusText(status) {
      const statusMap = {
        'safe': 'ì•ˆì •',
        'warning': 'ì£¼ì˜',
        'risk': 'ìœ„í—˜'
      };
      return statusMap[status] || 'ì•Œ ìˆ˜ ì—†ìŒ';
    }
    
    // ì¹´í˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ë§ˆì»¤ë¡œ í‘œì‹œ
    function loadCafeMarkers() {
      const params = new URLSearchParams();
      
      if (selectedRegion && selectedRegion !== 'ì„œìš¸ì‹œ ì „ì²´') {
        params.append('region', selectedRegion);
      }
      if (selectedMajorCategory && selectedMajorCategory !== 'type_all') {
        params.append('major_category', selectedMajorCategory);
      }
      if (selectedMidCategory && selectedMidCategory !== 'ì „ì²´') {
        params.append('mid_category', selectedMidCategory);
      }
      
      const apiUrl = `/api/cafes/cafes/map_markers/?${params.toString()}`;
      console.log('ì¹´í˜ ë§ˆì»¤ ë°ì´í„° ë¡œë”©:', apiUrl);
      
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('ì¹´í˜ ë§ˆì»¤ ë°ì´í„° ìˆ˜ì‹ :', data);
          if (data.success && data.markers) {
            displayCafeMarkers(data.markers);
          } else {
            console.warn('ë§ˆì»¤ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤:', data);
          }
        })
        .catch(error => {
          console.error('ì¹´í˜ ë§ˆì»¤ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
        });
    }
    
    // ì¹´í˜ ë§ˆì»¤ë“¤ì„ ì§€ë„ì— í‘œì‹œ
    function displayCafeMarkers(cafeData) {
      // ê¸°ì¡´ ë§ˆì»¤ë“¤ ì œê±°
      clearMarkers();
      
      cafeData.forEach(cafe => {
        if (cafe.latitude && cafe.longitude) {
          createCafeMarker(cafe);
        }
      });
      
      console.log(`${markers.length}ê°œ ì¹´í˜ ë§ˆì»¤ í‘œì‹œ ì™„ë£Œ`);
    }
    
    // KPI í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    document.addEventListener('DOMContentLoaded', function() {
      // KPI ìš”ì†Œë“¤ ì„ íƒ
      const kpiElements = document.querySelectorAll('.kpi .v');
      
      kpiElements.forEach((element, index) => {
        element.addEventListener('click', function(event) {
          event.stopPropagation();
          event.preventDefault();
          const kpiTitle = this.parentElement.querySelector('.t').textContent;
          openAnalysisModal(index, kpiTitle);
        });
      });
    });
    
    // ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    function openAnalysisModal(kpiIndex, title) {
      const modal = document.getElementById('analysisModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      
      // ëª¨ë‹¬ ì œëª© ì„¤ì •
      modalTitle.textContent = `${title} ìƒì„¸ ë¶„ì„`;
      
      // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
      modalContent.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner"></div>
        </div>
      `;
      
      // ëª¨ë‹¬ í‘œì‹œ
      modal.classList.add('active');
      
      // API í˜¸ì¶œí•˜ì—¬ ë°ì´í„° ë¡œë“œ
      loadAnalysisData(kpiIndex, title);
    }
    
    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeAnalysisModal() {
      const modal = document.getElementById('analysisModal');
      modal.classList.remove('active');
    }
    
    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    document.getElementById('analysisModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeAnalysisModal();
      }
    });
    
    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeAnalysisModal();
      }
    });
    
    // ë¶„ì„ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    function loadAnalysisData(kpiIndex, title) {
      const params = new URLSearchParams();
      
      // í˜„ì¬ í•„í„° ì¡°ê±´ ì¶”ê°€
      if (selectedRegion && selectedRegion !== 'ì„œìš¸ì‹œ ì „ì²´') {
        params.append('region', selectedRegion);
      }
      if (selectedMajorCategory && selectedMajorCategory !== 'type_all') {
        params.append('major_category', selectedMajorCategory);
      }
      if (selectedMidCategory && selectedMidCategory !== 'ì „ì²´') {
        params.append('mid_category', selectedMidCategory);
      }
      
      // KPIë³„ API ì—”ë“œí¬ì¸íŠ¸ ê²°ì •
      let apiEndpoint = '';
      switch(kpiIndex) {
        case 0: // í‘œì‹œëœ ìƒê¶Œ ìˆ˜
          apiEndpoint = 'store_count_analysis';
          break;
        case 1: // ì „ì²´ ì‚¬ì—…ì
          apiEndpoint = 'business_analysis';
          break;
        case 2: // í‰ê·  ì„±ì¥ë¥ 
          apiEndpoint = 'growth_rate_analysis';
          break;
        case 3: // ìœ„í—˜ ì§€ì—­
          apiEndpoint = 'risk_area_analysis';
          break;
        default:
          apiEndpoint = 'store_count_analysis';
      }
      
      const apiUrl = `/api/cafes/cafes/${apiEndpoint}/?${params.toString()}`;
      console.log(`${title} ìƒì„¸ ë¶„ì„ API í˜¸ì¶œ:`, apiUrl);
      
      fetch(apiUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log(`${title} ë¶„ì„ ë°ì´í„° ìˆ˜ì‹ :`, data);
          renderAnalysisData(data, kpiIndex, title);
        })
        .catch(error => {
          console.error(`${title} ë¶„ì„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:`, error);
          showErrorMessage();
        });
    }
    
    // ë¶„ì„ ë°ì´í„° ë Œë”ë§ í•¨ìˆ˜
    function renderAnalysisData(data, kpiIndex, title) {
      const modalContent = document.getElementById('modalContent');
      let html = '';
      
      switch(kpiIndex) {
        case 0: // í‘œì‹œëœ ìƒê¶Œ ìˆ˜ ë¶„ì„
          html = renderStoreCountAnalysis(data);
          break;
        case 1: // ì „ì²´ ì‚¬ì—…ì ë¶„ì„
          html = renderBusinessAnalysis(data);
          break;
        case 2: // í‰ê·  ì„±ì¥ë¥  ë¶„ì„
          html = renderGrowthRateAnalysis(data);
          break;
        case 3: // ìœ„í—˜ ì§€ì—­ ë¶„ì„
          html = renderRiskAreaAnalysis(data);
          break;
      }
      
      modalContent.innerHTML = html;
    }
    
    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showErrorMessage() {
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = `
        <div class="feed-card">
          <h3>âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨</h3>
          <div class="feed-content">
            ì£„ì†¡í•©ë‹ˆë‹¤. ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.
          </div>
        </div>
      `;
    }
    
    // ìƒê¶Œ ìˆ˜ ë¶„ì„ ë Œë”ë§
    function renderStoreCountAnalysis(data) {
      return `
        <div class="feed-card">
          <h3>ğŸ“Š ìƒê¶Œ ë¶„í¬ ë¶„ì„</h3>
          <div class="feed-meta">ì§€ì—­ë³„ ì¹´í˜ ìƒê¶Œ ë¶„í¬ í˜„í™©</div>
          
          <div class="highlight-stat">
            <span class="stat-label">ì´ ìƒê¶Œ ìˆ˜</span>
            <span class="stat-value">${data.total_count || 0}ê°œ</span>
          </div>
          
          <div class="highlight-stat">
            <span class="stat-label">í”„ëœì°¨ì´ì¦ˆ ë¹„ìœ¨</span>
            <span class="stat-value">${data.franchise_ratio || 0}%</span>
          </div>
          
          <div class="highlight-stat">
            <span class="stat-label">ê°œì¸ì¹´í˜ ë¹„ìœ¨</span>
            <span class="stat-value">${data.individual_ratio || 0}%</span>
          </div>
        </div>
        
        <div class="feed-card">
          <h3>ğŸ¢ ì—…ì¢…ë³„ ë¶„í¬</h3>
          <div class="feed-meta">í”„ëœì°¨ì´ì¦ˆ íƒ€ì…ë³„ ìƒê¶Œ ë¶„í¬</div>
          
          <ul class="trending-list">
            ${(data.franchise_distribution || []).map(item => `
              <li>
                <span>${item.franchise_type || 'ê¸°íƒ€'}</span>
                <span class="trend-up">${item.count || 0}ê°œ</span>
              </li>
            `).join('')}
          </ul>
        </div>
        
        <div class="feed-card">
          <h3>ğŸ“ ì§€ì—­ë³„ í˜„í™©</h3>
          <div class="feed-meta">êµ¬ë³„ ì¹´í˜ ìƒê¶Œ ë¶„í¬</div>
          
          <ul class="trending-list">
            ${(data.district_distribution || []).map(item => `
              <li>
                <span>${item.district || 'ê¸°íƒ€'}</span>
                <span class="trend-up">${item.count || 0}ê°œ</span>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    }
    
    // ì‚¬ì—…ì ë¶„ì„ ë Œë”ë§
    function renderBusinessAnalysis(data) {
      return `
        <div class="feed-card">
          <h3>ğŸª ì‚¬ì—…ì í˜„í™© ë¶„ì„</h3>
          <div class="feed-meta">ì „ì²´ ì‚¬ì—…ì ìš´ì˜ í˜„í™©</div>
          
          <div class="highlight-stat">
            <span class="stat-label">ì „ì²´ ì‚¬ì—…ì ìˆ˜</span>
            <span class="stat-value">${data.total_businesses || 0}ê°œ</span>
          </div>
          
          <div class="highlight-stat">
            <span class="stat-label">í‰ê·  ìš´ì˜ ê¸°ê°„</span>
            <span class="stat-value">${data.avg_operation_period || 0}ê°œì›”</span>
          </div>
          
          <div class="highlight-stat">
            <span class="stat-label">ì‹ ê·œ ì‚¬ì—…ì</span>
            <span class="stat-value">${data.new_businesses || 0}ê°œ</span>
          </div>
        </div>
        
        <div class="feed-card">
          <h3>ğŸ’° ë§¤ì¶œ êµ¬ê°„ë³„ ë¶„í¬</h3>
          <div class="feed-meta">ì›” ë§¤ì¶œ ê·œëª¨ë³„ ì‚¬ì—…ì ë¶„í¬</div>
          
          <ul class="trending-list">
            <li>
              <span>1000ë§Œì› ì´ìƒ</span>
              <span class="trend-up">${data.high_sales_count || 0}ê°œ</span>
            </li>
            <li>
              <span>500-1000ë§Œì›</span>
              <span class="trend-up">${data.mid_sales_count || 0}ê°œ</span>
            </li>
            <li>
              <span>500ë§Œì› ë¯¸ë§Œ</span>
              <span class="trend-down">${data.low_sales_count || 0}ê°œ</span>
            </li>
          </ul>
        </div>
        
        <div class="feed-card">
          <h3>âš ï¸ ìš´ì˜ ìœ„í—˜ë„</h3>
          <div class="feed-meta">ì‚¬ì—…ìë³„ ìš´ì˜ ìœ„í—˜ë„ ë¶„ì„</div>
          
          <div class="feed-content">
            <span class="tag">ìœ„í—˜ ìš”ì¸</span>
            ì €ì¡°í•œ ë§¤ì¶œ, ë†’ì€ ì„ëŒ€ë£Œ, ê²½ìŸ ê³¼ì—´ ë“±ì˜ ìš”ì¸ìœ¼ë¡œ 
            <strong>${data.risk_business_count || 0}ê°œ</strong> ì‚¬ì—…ìê°€ ìœ„í—˜ ìƒíƒœì…ë‹ˆë‹¤.
          </div>
        </div>
      `;
    }
    
    // ì„±ì¥ë¥  ë¶„ì„ ë Œë”ë§
    function renderGrowthRateAnalysis(data) {
      return `
        <div class="feed-card">
          <h3>ğŸ“ˆ ì„±ì¥ë¥  íŠ¸ë Œë“œ ë¶„ì„</h3>
          <div class="feed-meta">ì§€ì—­ í‰ê·  ì„±ì¥ë¥  ìƒì„¸ ë¶„ì„</div>
          
          <div class="highlight-stat">
            <span class="stat-label">í˜„ì¬ í‰ê·  ì„±ì¥ë¥ </span>
            <span class="stat-value">${data.current_growth_rate || 0}%</span>
          </div>
          
          <div class="highlight-stat">
            <span class="stat-label">ì „ë…„ ë™ê¸° ëŒ€ë¹„</span>
            <span class="stat-value ${(data.yoy_change || 0) >= 0 ? '' : 'danger'}">${data.yoy_change || 0}%</span>
          </div>
          
          <div class="highlight-stat">
            <span class="stat-label">ì˜ˆìƒ ì„±ì¥ë¥ </span>
            <span class="stat-value">${data.predicted_growth_rate || 0}%</span>
          </div>
        </div>
        
        <div class="feed-card">
          <h3>ğŸ¯ ì—…ì¢…ë³„ ì„±ì¥ë¥ </h3>
          <div class="feed-meta">í”„ëœì°¨ì´ì¦ˆ íƒ€ì…ë³„ ì„±ì¥ë¥  ë¹„êµ</div>
          
          <ul class="trending-list">
            ${(data.franchise_growth || []).map(item => `
              <li>
                <span>${item.franchise_type || 'ê¸°íƒ€'}</span>
                <span class="${(item.growth_rate || 0) >= 0 ? 'trend-up' : 'trend-down'}">
                  ${item.growth_rate || 0}%
                </span>
              </li>
            `).join('')}
          </ul>
        </div>
        
        <div class="feed-card">
          <h3>ğŸ” ì„±ì¥ ìš”ì¸ ë¶„ì„</h3>
          <div class="feed-meta">ì„±ì¥ë¥ ì— ì˜í–¥ì„ ë¯¸ì¹˜ëŠ” ì£¼ìš” ìš”ì¸</div>
          
          <div class="feed-content">
            <div style="margin-bottom: 16px;">
              <strong>ğŸŸ¢ ê¸ì • ìš”ì¸:</strong> ${data.positive_factors || 'ì¸êµ¬ ìœ ì…, êµí†µ ë°œë‹¬, ìƒê¶Œ í™œì„±í™”'}
            </div>
            
            <div style="margin-bottom: 16px;">
              <strong>ğŸŸ¡ ì£¼ì˜ ìš”ì¸:</strong> ${data.caution_factors || 'ì„ëŒ€ë£Œ ìƒìŠ¹, ê²½ìŸ ì¦ê°€'}
            </div>
            
            <div>
              <strong>ğŸ”´ ë¶€ì • ìš”ì¸:</strong> ${data.negative_factors || 'ì¸êµ¬ ê°ì†Œ, ìœ ë™ì¸êµ¬ ê°ì†Œ'}
            </div>
          </div>
        </div>
      `;
    }
    
    // ìœ„í—˜ ì§€ì—­ ë¶„ì„ ë Œë”ë§
    function renderRiskAreaAnalysis(data) {
      return `
        <div class="feed-card">
          <h3>âš ï¸ ìœ„í—˜ ì§€ì—­ í˜„í™©</h3>
          <div class="feed-meta">ì¹´í˜ ì°½ì—… ìœ„í—˜ ì§€ì—­ ë¶„ì„</div>
          
          <div class="highlight-stat">
            <span class="stat-label">ì´ ìœ„í—˜ ì§€ì—­</span>
            <span class="stat-value danger">${data.total_risk_areas || 0}ê³³</span>
          </div>
          
          <div class="highlight-stat">
            <span class="stat-label">ê³ ìœ„í—˜ ì§€ì—­</span>
            <span class="stat-value danger">${data.high_risk_areas || 0}ê³³</span>
          </div>
          
          <div class="highlight-stat">
            <span class="stat-label">ì¤‘ìœ„í—˜ ì§€ì—­</span>
            <span class="stat-value warning">${data.medium_risk_areas || 0}ê³³</span>
          </div>
        </div>
        
        <div class="feed-card">
          <h3>ğŸ“‹ ìœ„í—˜ ì§€ì—­ ëª©ë¡</h3>
          <div class="feed-meta">ìœ„í—˜ë„ ìˆœìœ„ë³„ ì§€ì—­ í˜„í™©</div>
          
          <ul class="trending-list">
            ${(data.risk_area_list || []).map(item => `
              <li>
                <span>${item.area_name || 'ì•Œ ìˆ˜ ì—†ìŒ'}</span>
                <span class="stat-value ${item.risk_level === 'high' ? 'danger' : item.risk_level === 'medium' ? 'warning' : ''}">
                  ${item.risk_score || 0}ì 
                </span>
              </li>
            `).join('')}
          </ul>
        </div>
        
        <div class="feed-card">
          <h3>ğŸ¯ ìœ„í—˜ ìš”ì¸ ë¶„ì„</h3>
          <div class="feed-meta">ìœ„í—˜ ì§€ì—­ì˜ ì£¼ìš” ì›ì¸</div>
          
          <div class="feed-content">
            <div style="margin-bottom: 16px;">
              <strong>ğŸ¢ ê³¼ë„í•œ ê²½ìŸ:</strong> ì¹´í˜ ë°€ë„ê°€ ë†’ì•„ ê²½ìŸì´ ì‹¬í•œ ì§€ì—­
            </div>
            
            <div style="margin-bottom: 16px;">
              <strong>ğŸ’° ë†’ì€ ì„ëŒ€ë£Œ:</strong> ì„ëŒ€ë£Œ ëŒ€ë¹„ ë§¤ì¶œì´ ë¶€ì¡±í•œ ì§€ì—­
            </div>
            
            <div style="margin-bottom: 16px;">
              <strong>ğŸ‘¥ ìœ ë™ì¸êµ¬ ë¶€ì¡±:</strong> ê³ ê° ìœ ì…ì´ ì ì€ ì§€ì—­
            </div>
            
            <div>
              <strong>ğŸ“‰ ë§¤ì¶œ ê°ì†Œ:</strong> ì§€ì†ì ìœ¼ë¡œ ë§¤ì¶œì´ í•˜ë½í•˜ëŠ” ì§€ì—­
            </div>
          </div>
        </div>
        
        <div class="feed-card">
          <h3>ğŸ’¡ ëŒ€ì•ˆ ì§€ì—­ ì¶”ì²œ</h3>
          <div class="feed-meta">ì•ˆì •ì ì¸ ì°½ì—… ê°€ëŠ¥ ì§€ì—­</div>
          
          <ul class="trending-list">
            ${(data.alternative_areas || []).map(item => `
              <li>
                <span>${item.area_name || 'ì¶”ì²œ ì§€ì—­'}</span>
                <span class="trend-up">${item.safety_score || 0}ì </span>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
    }
    
  </script>
</html>
